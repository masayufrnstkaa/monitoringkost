<!DOCTYPE html>
<html lang="id">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Dasbor Manajemen Kost Barokfi</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }

        .modal-bg {
            background-color: rgba(0, 0, 0, 0.5);
            transition: opacity 0.3s ease;
        }

        .modal-content {
            transition: transform 0.3s ease;
        }

        .metric-card {
            transition: transform .2s ease, box-shadow .2s ease, background-position .6s ease;
            background-size: 200% 200%;
        }

        .metric-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 12px 30px rgba(2, 132, 199, .12);
            background-position: 100% 0%;
        }

        .metric-icon-wrap {
            backdrop-filter: blur(6px);
        }
    </style>
</head>


<body class="bg-stone-50 text-slate-800">
    <div id="app" class="container mx-auto p-4 sm:p-6 lg:p-8">
        <header class="mb-8">
            <h1 class="text-3xl font-bold text-slate-900">Dasbor Manajemen Kost Barokfi</h1>
            <p class="text-slate-600 mt-1">Selamat datang! Pantau status pembayaran penyewa dan keuangan kos Anda di sini.</p>
        </header>

        <div class="flex flex-col sm:flex-row justify-end mb-6 gap-3">
            <button id="download-excel-btn" class="bg-green-600 text-white rounded-lg px-6 py-3 shadow-lg hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500 transition flex items-center justify-center gap-2">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                    <path fill-rule="evenodd" d="M3 17a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zm3.293-7.707a1 1 0 011.414 0L9 10.586V3a1 1 0 112 0v7.586l1.293-1.293a1 1 0 111.414 1.414l-3 3a1 1 0 01-1.414 0l-3-3a1 1 0 010-1.414z" clip-rule="evenodd" />
                </svg>
                Download Data (Excel)
            </button>
            <button id="add-expense-btn" class="bg-red-600 text-white rounded-lg px-6 py-3 shadow-lg hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-red-500 transition flex items-center justify-center gap-2">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6" />
                </svg>
                Tambah Pengeluaran
            </button>
            <button id="add-tenant-btn" class="bg-teal-600 text-white rounded-lg px-6 py-3 shadow-lg hover:bg-teal-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-teal-500 transition flex items-center justify-center gap-2">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6" />
                </svg>
                Tambah Penyewa Baru
            </button>
        </div>

        <main>
            <section id="metrics-cards" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-5 xl:grid-cols-5 gap-4 mb-6"></section>

            <div class="bg-white p-6 rounded-xl border border-stone-200 shadow-sm mb-6">
                <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-6 gap-4">
                    <h2 class="text-xl font-bold text-slate-900">Status Pembayaran Penyewa</h2>
                    <div id="filters" class="flex items-center gap-2 flex-wrap">
                        <button data-filter="all" class="filter-btn bg-teal-600 text-white px-4 py-2 text-sm font-medium rounded-lg shadow-sm">Semua Aktif</button>
                        <button data-filter="unpaid" class="filter-btn bg-white text-slate-700 px-4 py-2 text-sm font-medium rounded-lg border border-stone-300">Belum Lunas</button>
                        <button data-filter="due_soon" class="filter-btn bg-white text-slate-700 px-4 py-2 text-sm font-medium rounded-lg border border-stone-300">Jatuh Tempo</button>
                        <button data-filter="paid" class="filter-btn bg-white text-slate-700 px-4 py-2 text-sm font-medium rounded-lg border border-stone-300">Lunas</button>
                        <button data-filter="inactive" class="filter-btn bg-white text-slate-700 px-4 py-2 text-sm font-medium rounded-lg border border-stone-300">Tidak Aktif</button>
                    </div>
                </div>

                <div class="flex items-center gap-2 mb-4">
                    <label for="month-select" class="text-sm font-medium text-slate-700">Bulan:</label>
                    <select id="month-select" class="px-3 py-2 text-sm rounded-lg border border-stone-300 bg-white"></select>
                    <label for="year-select" class="text-sm font-medium text-slate-700">Tahun:</label>
                    <select id="year-select" class="px-3 py-2 text-sm rounded-lg border border-stone-300 bg-white"></select>
                    <button id="apply-period-filter" class="bg-teal-600 text-white px-4 py-2 text-sm font-medium rounded-lg shadow-sm hover:bg-teal-700">Terapkan</button>
                </div>

                <div class="overflow-x-auto">
                    <table class="w-full text-sm text-left text-slate-600">
                        <thead class="text-xs text-slate-700 uppercase bg-stone-50">
                            <tr>
                                <th scope="col" class="px-6 py-3">Penyewa</th>
                                <th scope="col" class="px-6 py-3">Tanggal Masuk</th>
                                <th scope="col" class="px-6 py-3">Harga per Bulan</th>
                                <th scope="col" class="px-6 py-3">Deposit</th>
                                <th scope="col" class="px-6 py-3">Interval</th>
                                <th scope="col" class="px-6 py-3">Jatuh Tempo</th>
                                <th scope="col" class="px-6 py-3">Status</th>
                                <th scope="col" class="px-6 py-3 text-center">Aksi</th>
                                <th scope="col" class="px-6 py-3 text-center">Hapus</th>
                            </tr>
                        </thead>
                        <tbody id="tenant-table-body"></tbody>
                    </table>
                    <p id="empty-state" class="text-center py-12 text-slate-500 hidden">Tidak ada data untuk filter yang dipilih.</p>
                </div>
            </div>

            <div class="bg-white p-6 rounded-xl border border-stone-200 shadow-sm">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-xl font-bold text-slate-900">Daftar Pengeluaran</h2>
                </div>
                <div class="overflow-x-auto">
                    <table class="w-full text-sm text-left text-slate-600">
                        <thead class="text-xs text-slate-700 uppercase bg-stone-50">
                            <tr>
                                <th scope="col" class="px-6 py-3">Tanggal</th>
                                <th scope="col" class="px-6 py-3">Deskripsi</th>
                                <th scope="col" class="px-6 py-3">Jumlah (Rp)</th>
                                <th scope="col" class="px-6 py-3 text-center">Aksi</th>
                            </tr>
                        </thead>
                        <tbody id="expense-table-body"></tbody>
                    </table>
                    <p id="empty-expense-state" class="text-center py-12 text-slate-500 hidden">Belum ada pengeluaran yang tercatat.</p>
                </div>
            </div>

        </main>
    </div>

    <div id="modal-container"></div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // --- DATA ---
            const NAMA_KOS = "Barokfi Kost Putra dan Putri";
            let tenants = [];
            let payments = [];
            let expenses = [];
            let currentFilter = 'all';

            const monthNames = ["Januari", "Februari", "Maret", "April", "Mei", "Juni", "Juli", "Agustus", "September", "Oktober", "November", "Desember"];

            const paymentIntervalLabels = {
                "monthly": "Bulanan",
                "bimonthly": "2 Bulanan",
                "quarterly": "3 Bulanan",
                "fourmonthly": "4 Bulanan",
                "fivemonthly": "5 Bulanan",
                "biannually": "6 Bulanan",
                "annually": "Tahunan"
            };
            const intervalToMonths = {
                "monthly": 1,
                "bimonthly": 2,
                "quarterly": 3,
                "fourmonthly": 4,
                "fivemonthly": 5,
                "biannually": 6,
                "annually": 12
            };

            let currentSelectedDate = new Date();
            currentSelectedDate.setDate(1);

            // --- LOCAL STORAGE ---
            const saveData = () => {
                try {
                    localStorage.setItem('tenantsData', JSON.stringify(tenants));
                    localStorage.setItem('paymentsData', JSON.stringify(payments));
                    localStorage.setItem('expensesData', JSON.stringify(expenses));
                } catch (e) {
                    console.error(e);
                    alert('Gagal menyimpan data.');
                }
            };

            const calculateInitialLastPaidPeriodEnd = (entryDate) => {
                const d = new Date(entryDate);
                d.setDate(d.getDate() - 1);
                d.setHours(23, 59, 59, 999);
                return d;
            };

            const loadData = () => {
                try {
                    const savedTenants = localStorage.getItem('tenantsData');
                    const savedPayments = localStorage.getItem('paymentsData');
                    const savedExpenses = localStorage.getItem('expensesData');

                    if (savedTenants) {
                        tenants = JSON.parse(savedTenants);
                        tenants.forEach(tenant => {
                            if (typeof tenant.entryDate === 'string') {
                                tenant.entryDate = new Date(tenant.entryDate);
                                tenant.entryDate.setHours(0, 0, 0, 0);
                            }
                            if (typeof tenant.lastPaidPeriodEnd === 'string') {
                                tenant.lastPaidPeriodEnd = new Date(tenant.lastPaidPeriodEnd);
                                tenant.lastPaidPeriodEnd.setHours(23, 59, 59, 999);
                            } else if (tenant.lastPaidPeriodEnd === undefined) {
                                tenant.lastPaidPeriodEnd = calculateInitialLastPaidPeriodEnd(tenant.entryDate);
                            }
                            tenant.deposit = tenant.deposit ? parseFloat(tenant.deposit) : 0;
                            tenant.paymentInterval = tenant.paymentInterval || 'monthly';
                            if (tenant.isActive === undefined) {
                                tenant.isActive = true;
                            }
                            if (typeof tenant.terminationDate === 'string' && tenant.terminationDate !== "null") {
                                tenant.terminationDate = new Date(tenant.terminationDate);
                                tenant.terminationDate.setHours(23, 59, 59, 999);
                            } else {
                                tenant.terminationDate = null;
                            }
                        });
                    }

                    if (savedPayments) {
                        payments = JSON.parse(savedPayments);
                        payments.forEach(payment => {
                            if (typeof payment.date === 'string') {
                                payment.date = new Date(payment.date);
                                payment.date.setHours(0, 0, 0, 0);
                            }
                            if (typeof payment.periodEndCovered === 'string') {
                                payment.periodEndCovered = new Date(payment.periodEndCovered);
                                payment.periodEndCovered.setHours(23, 59, 59, 999);
                            }
                            if (payment.paidForInterval === undefined) {
                                const tenant = tenants.find(t => t.id === payment.tenantId);
                                payment.paidForInterval = tenant ? tenant.paymentInterval : 'monthly';
                            }
                        });
                    }

                    if (savedExpenses) {
                        expenses = JSON.parse(savedExpenses);
                        expenses.forEach(expense => {
                            if (typeof expense.date === 'string') {
                                expense.date = new Date(expense.date);
                                expense.date.setHours(0, 0, 0, 0);
                            }
                        });
                    }

                } catch (e) {
                    console.error(e);
                    alert('Gagal memuat data.');
                }
            };

            // --- UTIL ---
            const formatCurrency = (amount) => `Rp ${new Intl.NumberFormat('id-ID').format(Math.round(amount || 0))}`;
            const addMonths = (date, months) => {
                const d = new Date(date);
                const originalDay = d.getDate();
                d.setMonth(d.getMonth() + months);
                if (d.getDate() !== originalDay) {
                    const lastDay = new Date(d.getFullYear(), d.getMonth() + 1, 0).getDate();
                    d.setDate(Math.min(originalDay, lastDay));
                }
                return d;
            };
            const endOfMonth = (y, m) => new Date(y, m + 1, 0, 23, 59, 59, 999);
            const getExpectedDueDate = (tenant) => {
                let nextPeriodStartDate = new Date(tenant.lastPaidPeriodEnd);
                nextPeriodStartDate.setDate(nextPeriodStartDate.getDate() + 1);
                nextPeriodStartDate.setHours(0, 0, 0, 0);
                return nextPeriodStartDate;
            };

            // STATUS / PERIODE
            const getTenantPaymentStatus = (tenant, selectedDate) => {
                const targetMonth = selectedDate.getMonth();
                const targetYear = selectedDate.getFullYear();
                const entryDate = new Date(tenant.entryDate);
                entryDate.setHours(0, 0, 0, 0);
                const today = new Date();
                today.setHours(0, 0, 0, 0);

                const startOfSelectedMonth = new Date(targetYear, targetMonth, 1);
                startOfSelectedMonth.setHours(0, 0, 0, 0);
                const endOfSelectedMonth = new Date(targetYear, targetMonth + 1, 0);
                endOfSelectedMonth.setHours(23, 59, 59, 999);

                if (!tenant.isActive && tenant.terminationDate && tenant.terminationDate < startOfSelectedMonth) {
                    return {
                        ...tenant,
                        dueDate: null,
                        totalPaid: 0,
                        isPaid: true,
                        status: 'inactive_terminated',
                        statusText: `Berhenti Sewa (${new Date(tenant.terminationDate).toLocaleDateString('id-ID')})`,
                        statusColor: 'bg-red-100 text-red-800',
                        diffDays: null
                    };
                }

                if (startOfSelectedMonth.getTime() < new Date(entryDate.getFullYear(), entryDate.getMonth(), 1).getTime()) {
                    return {
                        ...tenant,
                        dueDate: null,
                        totalPaid: 0,
                        isPaid: false,
                        status: 'not_yet_entered',
                        statusText: 'Penyewa belum masuk',
                        statusColor: 'bg-stone-200 text-stone-700',
                        diffDays: null
                    };
                }

                let calculatedDueDate = getExpectedDueDate(tenant);
                let tempPeriodsAdvanced = 0;
                let monthsToAdvance;
                const isFirstPayment = tenant.lastPaidPeriodEnd.getTime() === calculateInitialLastPaidPeriodEnd(tenant.entryDate).getTime();
                if (isFirstPayment) {
                    monthsToAdvance = intervalToMonths[tenant.paymentInterval];
                } else {
                    monthsToAdvance = 1;
                }

                if (!tenant.isActive && tenant.terminationDate && tenant.terminationDate >= startOfSelectedMonth) {
                    let isPaidForMonth = tenant.lastPaidPeriodEnd >= endOfSelectedMonth;
                    if (isPaidForMonth) {
                        return {
                            ...tenant,
                            dueDate: null,
                            totalPaid: 0,
                            isPaid: true,
                            status: 'inactive_paid',
                            statusText: `Berhenti Sewa (${new Date(tenant.terminationDate).toLocaleDateString('id-ID')}) - Lunas`,
                            statusColor: 'bg-red-100 text-red-600',
                            diffDays: null
                        };
                    } else {
                        return {
                            ...tenant,
                            dueDate: calculatedDueDate,
                            totalPaid: 0,
                            isPaid: false,
                            status: 'inactive_unpaid',
                            statusText: `Berhenti Sewa (${new Date(tenant.terminationDate).toLocaleDateString('id-ID')}) - Belum Lunas`,
                            statusColor: 'bg-red-300 text-red-900',
                            diffDays: null
                        };
                    }
                }

                while (calculatedDueDate < startOfSelectedMonth && tempPeriodsAdvanced < 24) {
                    calculatedDueDate = addMonths(calculatedDueDate, monthsToAdvance);
                    tempPeriodsAdvanced++;
                }

                let dueDate = calculatedDueDate;
                let isPaidForCurrentPeriod = tenant.lastPaidPeriodEnd && tenant.lastPaidPeriodEnd >= endOfSelectedMonth;
                const diffTime = dueDate.getTime() - today.getTime();
                const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
                const isEntryMonth = (targetYear === entryDate.getFullYear() && targetMonth === entryDate.getMonth());

                let status, statusText, statusColor;
                if (isPaidForCurrentPeriod) {
                    status = 'paid';
                    statusText = 'Lunas';
                    statusColor = 'bg-teal-100 text-teal-800';
                } else {
                    if (isEntryMonth) {
                        status = 'first_month_unpaid';
                        statusText = 'Bulan pertama penyewa masuk';
                        statusColor = 'bg-blue-100 text-blue-800';
                    } else if (dueDate <= today) {
                        status = 'overdue';
                        statusText = `Terlambat ${Math.abs(diffDays)} hari`;
                        statusColor = 'bg-red-100 text-red-800';
                    } else if (diffDays > 0 && diffDays <= 7) {
                        status = 'due_soon';
                        statusText = `Jatuh tempo dalam ${diffDays} hari`;
                        statusColor = 'bg-amber-100 text-amber-800';
                    } else {
                        status = 'unpaid';
                        statusText = 'Belum Lunas';
                        statusColor = 'bg-stone-100 text-stone-800';
                    }
                }

                const paymentsInCurrentMonth = payments
                    .filter(p => p.tenantId === tenant.id && p.date.getMonth() === currentSelectedDate.getMonth() && p.date.getFullYear() === currentSelectedDate.getFullYear())
                    .reduce((sum, p) => sum + p.amount, 0);

                return {
                    ...tenant,
                    dueDate,
                    totalPaid: paymentsInCurrentMonth,
                    isPaid: isPaidForCurrentPeriod,
                    status,
                    statusText,
                    statusColor,
                    diffDays
                };
            };

            // ====== METRIK ======
            const isActiveInSelectedMonth = (tenant, selectedDate) => {
                const y = selectedDate.getFullYear();
                const m = selectedDate.getMonth();
                const startOfSelectedMonth = new Date(y, m, 1);
                startOfSelectedMonth.setHours(0, 0, 0, 0);
                const endOfSelectedMonth = new Date(y, m + 1, 0, 23, 59, 59, 999);

                if (tenant.entryDate > endOfSelectedMonth) {
                    return false;
                }

                if (!tenant.isActive && tenant.terminationDate && tenant.terminationDate < endOfSelectedMonth) {
                    return false;
                }

                return true;
            };

            const rentPerMonth = (tenant) => {
                const months = intervalToMonths[tenant.paymentInterval] || 1;
                return (tenant.rent || 0) / months;
            };

            const calculateMonthlyIncome = (selectedDate) => {
                const paidTenants = tenants.filter(t => {
                    if (!isActiveInSelectedMonth(t, selectedDate)) return false;
                    const status = getTenantPaymentStatus(t, selectedDate);
                    return status.isPaid;
                });
                return paidTenants.reduce((sum, t) => sum + rentPerMonth(t), 0);
            };

            const calculateYearlyIncome = (selectedYear) => {
                return payments
                    .filter(p => p.date.getFullYear() === selectedYear)
                    .reduce((sum, p) => sum + p.amount, 0);
            };

            const calculateOverallIncome = () => {
                return payments.reduce((sum, p) => sum + p.amount, 0);
            };

            const calculateMonthlyExpenses = (selectedDate) => {
                const month = selectedDate.getMonth();
                const year = selectedDate.getFullYear();
                return expenses
                    .filter(e => e.date.getMonth() === month && e.date.getFullYear() === year)
                    .reduce((sum, e) => sum + e.amount, 0);
            };

            const renderMetricsCards = () => {
                const cardsWrap = document.getElementById('metrics-cards');
                const year = currentSelectedDate.getFullYear();
                const monthIdx = currentSelectedDate.getMonth();
                const monthLabel = `${monthNames[monthIdx]} ${year}`;

                const occupiedTenants = tenants.filter(t => isActiveInSelectedMonth(t, currentSelectedDate));
                const occupiedCount = occupiedTenants.length;

                const processedTenants = occupiedTenants.map(t => ({
                    t,
                    status: getTenantPaymentStatus(t, currentSelectedDate)
                }));

                const monthlyArrears = processedTenants
                    .filter(x => ['overdue', 'due_soon', 'unpaid', 'first_month_unpaid', 'inactive_unpaid'].includes(x.status.status))
                    .reduce((sum, x) => sum + rentPerMonth(x.t), 0);

                const monthlyIncome = calculateMonthlyIncome(currentSelectedDate);
                const monthlyExpenses = calculateMonthlyExpenses(currentSelectedDate);
                const monthlyNet = monthlyIncome - monthlyExpenses;

                const yearlyIncome = calculateYearlyIncome(year);
                const yearlyExpenses = expenses
                    .filter(e => e.date.getFullYear() === year)
                    .reduce((sum, e) => sum + e.amount, 0);
                const yearlyNet = yearlyIncome - yearlyExpenses;

                const overallIncome = calculateOverallIncome();
                const overallExpenses = expenses.reduce((sum, e) => sum + e.amount, 0);
                const overallNet = overallIncome - overallExpenses;

                const cards = [{
                    title: 'Pemasukan Bulan Ini',
                    value: formatCurrency(monthlyIncome),
                    sub: `Estimasi dari yang Lunas`,
                    gradient: 'from-cyan-500 via-sky-500 to-blue-500',
                    ring: 'ring-sky-200/60',
                    icon: `<svg class="h-5 w-5" viewBox="0 0 24 24" fill="currentColor"><path d="M12 1a1 1 0 011 1v1.05a7.002 7.002 0 015.95 5.95H20a1 1 0 110 2h-1.05a7.002 7.002 0 01-5.95 5.95V20a1 1 0 11-2 0v-1.05A7.002 7.002 0 014.05 12H3a1 1 0 110-2h1.05A7.002 7.002 0 0110 3.05V2a1 1 0 011-1zm0 5a6 6 0 100 12 6 6 0 000-12z"/></svg>`
                }, {
                    title: 'Pemasukan Tahun Ini',
                    value: formatCurrency(yearlyIncome),
                    sub: `Total dari ${year}`,
                    gradient: 'from-emerald-500 via-teal-500 to-cyan-500',
                    ring: 'ring-emerald-200/60',
                    icon: `<svg class="h-5 w-5" viewBox="0 0 24 24" fill="currentColor"><path d="M3 3h18v4H3V3zm0 6h8v12H3V9zm10 0h8v12h-8V9z"/></svg>`
                }, {
                    title: 'Pemasukan Keseluruhan',
                    value: formatCurrency(overallIncome),
                    sub: `Total dari awal`,
                    gradient: 'from-fuchsia-500 via-purple-500 to-indigo-500',
                    ring: 'ring-fuchsia-200/60',
                    icon: `<svg class="h-5 w-5" viewBox="0 0 24 24" fill="currentColor"><path d="M4 4h16v2H4zM4 9h10v2H4zM4 14h14v2H4zM4 19h8v2H4z"/></svg>`
                }, {
                    title: 'Pengeluaran Bulan Ini',
                    value: formatCurrency(monthlyExpenses),
                    sub: monthLabel,
                    gradient: 'from-red-500 via-orange-500 to-amber-500',
                    ring: 'ring-red-200/60',
                    icon: `<svg class="h-5 w-5" viewBox="0 0 24 24" fill="currentColor"><path fill-rule="evenodd" d="M18.736 10.428A3.75 3.75 0 0116.5 9.75h-.766c-.66 0-1.29.176-1.851.51l-4.225 2.535a4.5 4.5 0 01-5.694-2.815c.676-.046 1.353-.081 2.031-.102.16-.948.336-1.895.52-2.842a.75.75 0 00-1.286-.543c-.477.893-.974 1.838-1.503 2.815-1.996 3.864-1.996 8.16 0 12.024-.529-.977-1.026-1.922-1.503-2.815a.75.75 0 00-1.286.543c.184.947.36 1.894.52 2.842.678.021 1.355.056 2.031.102a4.502 4.502 0 01-5.694 2.815l-4.225-2.535A3.75 3.75 0 0116.5 14.25h.766c.66 0 1.29-.176 1.851-.51L22.375 11a.75.75 0 000-1.286L18.736 10.428z" clip-rule="evenodd"/></svg>`
                }, {
                    title: 'Laba Bersih Bulan Ini',
                    value: formatCurrency(monthlyNet),
                    sub: `Pemasukan - Pengeluaran`,
                    gradient: 'from-green-500 via-emerald-500 to-lime-500',
                    ring: 'ring-green-200/60',
                    icon: `<svg class="h-5 w-5" viewBox="0 0 24 24" fill="currentColor"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm1 15h-2v-4H7l5-5 5 5h-4v4z"/></svg>`
                }, {
                    title: 'Total Tunggakan (Estimasi)',
                    value: formatCurrency(monthlyArrears),
                    sub: 'Belum lunas & jatuh tempo',
                    gradient: 'from-amber-500 via-orange-500 to-rose-500',
                    ring: 'ring-amber-200/60',
                    icon: `<svg class="h-5 w-5" viewBox="0 0 24 24" fill="currentColor"><path d="M11 7h2v6h-2V7zm0 8h2v2h-2v-2z"/><path d="M1 21h22L12 2 1 21z"/></svg>`
                }, {
                    title: 'Kamar Terisi',
                    value: occupiedCount.toString(),
                    sub: monthLabel,
                    gradient: 'from-sky-600 via-blue-600 to-indigo-600',
                    ring: 'ring-blue-200/60',
                    icon: `<svg class="h-5 w-5" viewBox="0 0 24 24" fill="currentColor"><path d="M7 11h10a4 4 0 014 4v5H3v-5a4 4 0 014-4zm5-2a4 4 0 100-8 4 4 0 000 8z"/></svg>`
                }, ];

                const cardHTML = (c) => `
          <div class="metric-card relative rounded-2xl p-4 ring-1 ${c.ring}
                      bg-gradient-to-br ${c.gradient} text-white shadow-sm">
            <div class="flex items-start justify-between gap-3">
              <div>
                <div class="text-xs uppercase tracking-wide opacity-90">${c.title}</div>
                <div class="mt-1 text-3xl font-extrabold drop-shadow-sm">${c.value}</div>
                <div class="mt-1 text-xs opacity-90">${c.sub}</div>
              </div>
              <div class="metric-icon-wrap shrink-0 rounded-xl p-2 bg-white/10 ring-1 ring-white/20 shadow-inner">
                ${c.icon}
              </div>
            </div>
            <div class="absolute inset-0 rounded-2xl ring-1 ring-inset ring-white/10 pointer-events-none"></div>
          </div>`;
                cardsWrap.innerHTML = cards.map(cardHTML).join('');
            };

            // --- CSV ---
            const downloadExcel = () => {
                const dataPenyewa = [
                    ['Data Penyewa Kost'],
                    [''],
                    ['Nama Penyewa', 'No. Kamar', 'No. WA', 'Tanggal Masuk', 'Harga Sewa (Rp / Interval)', 'Harga per Bulan (Rp)', 'Uang Deposit (Rp)', 'Interval Pembayaran', `Status Pembayaran (${monthNames[currentSelectedDate.getMonth()]} ${currentSelectedDate.getFullYear()})`, `Jatuh Tempo Pembayaran Berikutnya`, 'Tanggal Akhir Periode Terakhir Dibayar', 'Status Aktif', 'Tanggal Berhenti Sewa']
                ];
                tenants.sort((a, b) => parseInt(a.room) - parseInt(b.room)).forEach(tenant => {
                    const statusData = getTenantPaymentStatus(tenant, currentSelectedDate);
                    const monthsInInterval = intervalToMonths[tenant.paymentInterval] || 1;
                    const rentPerMonthVal = tenant.rent / monthsInInterval;
                    dataPenyewa.push([
                        tenant.name, tenant.room, `'${tenant.phone}`,
                        new Date(tenant.entryDate).toLocaleDateString('id-ID'),
                        tenant.rent, Math.round(rentPerMonthVal),
                        tenant.deposit, paymentIntervalLabels[tenant.paymentInterval],
                        statusData.statusText,
                        statusData.dueDate ? new Date(statusData.dueDate).toLocaleDateString('id-ID') : '-',
                        tenant.lastPaidPeriodEnd ? new Date(tenant.lastPaidPeriodEnd).toLocaleDateString('id-ID') : '-',
                        tenant.isActive ? 'Aktif' : 'Tidak Aktif',
                        tenant.terminationDate ? new Date(tenant.terminationDate).toLocaleDateString('id-ID') : '-'
                    ]);
                });

                const dataPengeluaran = [
                    [],
                    ['Data Pengeluaran'],
                    [''],
                    ['Tanggal', 'Deskripsi', 'Jumlah (Rp)']
                ];
                expenses.forEach(expense => {
                    dataPengeluaran.push([
                        new Date(expense.date).toLocaleDateString('id-ID'),
                        expense.description,
                        expense.amount
                    ]);
                });

                const allData = [...dataPenyewa, ...dataPengeluaran];
                let csvContent = "data:text/csv;charset=utf-8," + allData.map(e => e.join(",")).join("\n");
                const encodedUri = encodeURI(csvContent);
                const link = document.createElement("a");
                link.setAttribute("href", encodedUri);
                link.setAttribute("download", `data_keuangan_kos_${monthNames[currentSelectedDate.getMonth()]}_${currentSelectedDate.getFullYear()}.csv`);
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            };

            // --- RENDER TABEL ---
            const populateMonthYearSelectors = () => {
                const monthSelect = document.getElementById('month-select');
                const yearSelect = document.getElementById('year-select');
                const currentYear = new Date().getFullYear();
                monthSelect.innerHTML = '';
                yearSelect.innerHTML = '';
                monthNames.forEach((name, index) => {
                    const option = document.createElement('option');
                    option.value = index;
                    option.textContent = name;
                    if (index === currentSelectedDate.getMonth()) option.selected = true;
                    monthSelect.appendChild(option);
                });
                for (let i = currentYear - 2; i <= currentYear + 5; i++) {
                    const option = document.createElement('option');
                    option.value = i;
                    option.textContent = i;
                    if (i === currentSelectedDate.getFullYear()) option.selected = true;
                    yearSelect.appendChild(option);
                }
            };

            const renderTable = () => {
                const tableBody = document.getElementById('tenant-table-body');
                const emptyState = document.getElementById('empty-state');
                tableBody.innerHTML = '';

                let processedTenants = tenants.map(t => getTenantPaymentStatus(t, currentSelectedDate));
                let filteredTenants = [];
                const startOfSelectedMonth = new Date(currentSelectedDate.getFullYear(), currentSelectedDate.getMonth(), 1);
                startOfSelectedMonth.setHours(0, 0, 0, 0);

                if (currentFilter === 'inactive') {
                    filteredTenants = processedTenants.filter(t => !t.isActive);
                } else {
                    filteredTenants = processedTenants.filter(t => isActiveInSelectedMonth(t, currentSelectedDate));

                    filteredTenants = filteredTenants.filter(t => {
                        if (t.status === 'not_yet_entered') return false;
                        if (currentFilter === 'all') return true;
                        if (currentFilter === 'paid') return t.isPaid;
                        if (currentFilter === 'unpaid') return !t.isPaid && (t.status === 'overdue' || t.status === 'unpaid' || t.status === 'due_soon' || t.status === 'first_month_unpaid' || t.status === 'inactive_unpaid');
                        if (currentFilter === 'due_soon') return !t.isPaid && t.status === 'due_soon';
                        return true;
                    });
                }

                const statusOrder = {
                    'overdue': 1,
                    'due_soon': 2,
                    'first_month_unpaid': 3,
                    'unpaid': 4,
                    'paid': 5,
                    'inactive_unpaid': 6,
                    'inactive_paid': 7,
                    'inactive_terminated': 8,
                    'not_yet_entered': 9
                };
                filteredTenants.sort((a, b) => {
                    const orderA = statusOrder[a.status];
                    const orderB = statusOrder[b.status];
                    if (orderA !== orderB) return orderA - orderB;
                    if (a.status === 'overdue' || a.status === 'due_soon') return a.diffDays - b.diffDays;
                    return 0;
                });

                if (filteredTenants.length === 0) {
                    emptyState.classList.remove('hidden');
                    tableBody.classList.add('hidden');
                } else {
                    emptyState.classList.add('hidden');
                    tableBody.classList.remove('hidden');
                }

                filteredTenants.forEach(tenant => {
                    let dueDateDisplay = '';
                    let actionButtons = '';
                    let deleteButton = '';

                    if (tenant.status === 'first_month_unpaid') {
                        dueDateDisplay = `<span class="text-slate-700">Bulan pertama penyewa masuk</span>`;
                    } else if (tenant.dueDate) {
                        const dueDateFormatted = new Intl.DateTimeFormat('id-ID', {
                            day: 'numeric',
                            month: 'long',
                            year: 'numeric'
                        }).format(tenant.dueDate);
                        dueDateDisplay = dueDateFormatted;
                        if (!tenant.isPaid && (tenant.status === 'overdue' || tenant.status === 'due_soon' || tenant.status === 'unpaid')) {
                            if (tenant.statusText) {
                                dueDateDisplay += ` <span class="text-xs text-slate-500">(${tenant.statusText})</span>`;
                            }
                        }
                    } else {
                        dueDateDisplay = '<span class="text-slate-500">-</span>';
                    }

                    const monthsInInterval = intervalToMonths[tenant.paymentInterval];
                    const rentPerMonthDisplay = formatCurrency(Math.round(tenant.rent / monthsInInterval));

                    const waBaseText = `Halo kak ${tenant.name} dari Kamar ${tenant.room},`;
                    let waMessageBody = '';
                    let paymentPeriodText = '';

                    if (tenant.isActive) {
                        if (tenant.dueDate) {
                            let tempPeriodStart = new Date(tenant.dueDate);
                            let tempPeriodEnd = addMonths(tempPeriodStart, intervalToMonths[tenant.paymentInterval]);
                            tempPeriodEnd.setDate(tempPeriodEnd.getDate() - 1);

                            switch (tenant.paymentInterval) {
                                case 'monthly':
                                    paymentPeriodText = `untuk bulan ${new Intl.DateTimeFormat('id-ID',{month:'long',year:'numeric'}).format(tempPeriodStart)}`;
                                    break;
                                default:
                                    paymentPeriodText = `untuk periode ${new Intl.DateTimeFormat('id-ID',{month:'long'}).format(tempPeriodStart)} - ${new Intl.DateTimeFormat('id-ID',{month:'long',year:'numeric'}).format(tempPeriodEnd)}`;
                                    break;
                            }
                        }
                        if (tenant.status === 'overdue') {
                            waMessageBody = ` Pembayaran sewa kos Anda ${paymentPeriodText} sebesar ${formatCurrency(tenant.rent)} telah melewati tanggal jatuh tempo ${new Intl.DateTimeFormat('id-ID',{day:'2-digit',month:'long',year:'numeric'}).format(tenant.dueDate)} dan terlambat ${Math.abs(tenant.diffDays)} hari. Mohon segera dilunasi untuk menghindari denda keterlambatan.`;
                        } else if (tenant.status === 'due_soon' && tenant.diffDays === 0) {
                            waMessageBody = ` Pembayaran sewa kos Anda ${paymentPeriodText} sebesar ${formatCurrency(tenant.rent)} jatuh tempo HARI INI, ${new Intl.DateTimeFormat('id-ID',{day:'2-digit',month:'long',year:'numeric'}).format(tenant.dueDate)}.%0AMohon segera dilunasi.`;
                        } else if (tenant.status === 'due_soon' && tenant.diffDays > 0) {
                            waMessageBody = ` Kami ingin mengingatkan bahwa pembayaran sewa kos ${paymentPeriodText} sebesar ${formatCurrency(tenant.rent)} akan jatuh tempo pada tanggal ${new Intl.DateTimeFormat('id-ID',{day:'2-digit',month:'long',year:'numeric'}).format(tenant.dueDate)} (dalam ${tenant.diffDays} hari). Mohon segera dilakukan pembayaran.`;
                        } else if (tenant.status === 'unpaid' || tenant.status === 'first_month_unpaid') {
                            waMessageBody = ` Pembayaran sewa kos Anda ${paymentPeriodText} sebesar ${formatCurrency(tenant.rent)} belum lunas dan telah jatuh tempo pada tanggal ${new Intl.DateTimeFormat('id-ID',{day:'2-digit',month:'long',year:'numeric'}).format(tenant.dueDate)}. Mohon segera dilunasi.`;
                        }
                        const waClosing = ` Terima kasih. Pemilik ${NAMA_KOS}`;
                        const waLink = (waMessageBody && tenant.phone) ? `https://wa.me/${tenant.phone}?text=${encodeURIComponent(waBaseText + waMessageBody + waClosing)}` : '';

                        actionButtons = `
                        <button data-action="edit-tenant" data-id="${tenant.id}" class="text-blue-600 hover:text-blue-800 font-medium">Edit</button>

                        ${(!tenant.isPaid && tenant.status !== 'not_yet_entered') ? `
                            <button data-action="log-payment" data-id="${tenant.id}" class="text-teal-600 hover:text-teal-800 font-medium">Bayar</button>
                            ${waLink ? `<a href="${waLink}" target="_blank" class="text-amber-600 hover:text-amber-800 font-medium">WA</a>` : ''}
                        ` : ''}

                        <button data-action="download-nota" data-id="${tenant.id}"
                            class="text-purple-600 hover:text-purple-800 font-medium">
                            Nota
                        </button>

                        <button data-action="terminate-tenant" data-id="${tenant.id}"
                            class="text-red-500 hover:text-red-700 font-medium ml-2 text-xs py-1 px-2 rounded border border-red-500">
                            Akhiri Sewa
                        </button>
                        `;

                        deleteButton = `<button data-action="delete-tenant" data-id="${tenant.id}" class="text-red-600 hover:text-red-800 font-medium">Hapus</button>`;
                    } else {
                         actionButtons = `
                            <button data-action="edit-tenant" data-id="${tenant.id}" class="text-blue-600 hover:text-blue-800 font-medium">Lihat/Edit</button>
                            <button data-action="reactivate-tenant" data-id="${tenant.id}" class="text-green-600 hover:text-green-800 font-medium ml-2 text-xs py-1 px-2 rounded border border-green-600">Aktifkan Lagi</button>
                         `;
                         deleteButton = `<button data-action="delete-tenant" data-id="${tenant.id}" class="text-red-600 hover:text-red-800 font-medium">Hapus</button>`;
                    }

                    const row = `
              <tr class="bg-white border-b border-stone-200 hover:bg-stone-50">
                <td class="px-6 py-4 font-medium text-slate-900">${tenant.name}<div class="text-xs text-slate-500">Kamar ${tenant.room}</div></td>
                <td class="px-6 py-4">${new Date(tenant.entryDate).toLocaleDateString('id-ID')}</td>
                <td class="px-6 py-4">${rentPerMonthDisplay}</td>
                <td class="px-6 py-4">${formatCurrency(tenant.deposit)}</td>
                <td class="px-6 py-4">${paymentIntervalLabels[tenant.paymentInterval]}</td>
                <td class="px-6 py-4">${dueDateDisplay}</td>
                <td class="px-6 py-4"><span class="px-2 py-1 text-xs font-medium rounded-full ${tenant.statusColor}">${tenant.statusText}</span></td>
                <td class="px-6 py-4 text-center flex flex-wrap items-center justify-center gap-2">
                    ${actionButtons}
                </td>
                <td class="px-6 py-4 text-center">${deleteButton}</td>
              </tr>`;
                    tableBody.innerHTML += row;
                });
            };

            const renderExpenseTable = () => {
                const tableBody = document.getElementById('expense-table-body');
                const emptyState = document.getElementById('empty-expense-state');
                tableBody.innerHTML = '';

                const sortedExpenses = [...expenses].sort((a, b) => b.date - a.date);

                if (sortedExpenses.length === 0) {
                    emptyState.classList.remove('hidden');
                } else {
                    emptyState.classList.add('hidden');
                    sortedExpenses.forEach(expense => {
                        const row = `
                            <tr class="bg-white border-b border-stone-200 hover:bg-stone-50">
                                <td class="px-6 py-4">${new Date(expense.date).toLocaleDateString('id-ID')}</td>
                                <td class="px-6 py-4">${expense.description}</td>
                                <td class="px-6 py-4">${formatCurrency(expense.amount)}</td>
                                <td class="px-6 py-4 text-center flex items-center justify-center gap-2">
                                    <button data-action="edit-expense" data-id="${expense.id}" class="text-blue-600 hover:text-blue-800 font-medium">Edit</button>
                                    <button data-action="delete-expense" data-id="${expense.id}" class="text-red-600 hover:text-red-800 font-medium">Hapus</button>
                                </td>
                            </tr>
                        `;
                        tableBody.innerHTML += row;
                    });
                }
            };

            const renderModal = (type, id = null) => {
                const modalContainer = document.getElementById('modal-container');
                let title = '',
                    content = '';
                const tenant = id ? tenants.find(t => t.id === id) : null;
                const expense = id ? expenses.find(e => e.id === id) : null;

                if (type === 'addTenant' || type === 'editTenant') {
                    const isEdit = type === 'editTenant';
                    const entryDateValue = isEdit && tenant.entryDate ? tenant.entryDate.toISOString().split('T')[0] : '';
                    const rentPerMonthValue = isEdit ? ((tenant.rent || 0) / (intervalToMonths[tenant.paymentInterval] || 1)) : '';
                    title = type === 'addTenant' ? "Tambah Penyewa Baru" : "Edit Data Penyewa";

                    content = `
                        <div class="space-y-4">
                            <div>
                                <label for="name" class="block text-sm font-medium text-slate-700">Nama Lengkap</label>
                                <input type="text" id="name" required class="mt-1 block w-full px-3 py-2 bg-white border border-stone-300 rounded-md shadow-sm focus:outline-none focus:ring-teal-500 focus:border-teal-500" value="${isEdit ? tenant.name : ''}">
                            </div>
                            <div class="grid grid-cols-2 gap-4">
                                <div>
                                    <label for="room" class="block text-sm font-medium text-slate-700">No. Kamar</label>
                                    <input type="text" id="room" required class="mt-1 block w-full px-3 py-2 bg-white border border-stone-300 rounded-md shadow-sm focus:outline-none focus:ring-teal-500 focus:border-teal-500" value="${isEdit ? tenant.room : ''}">
                                </div>
                                <div>
                                    <label for="phone" class="block text-sm font-medium text-slate-700">No. WA (62..)</label>
                                    <input type="text" id="phone" required placeholder="62812..." class="mt-1 block w-full px-3 py-2 bg-white border border-stone-300 rounded-md shadow-sm focus:outline-none focus:ring-teal-500 focus:border-teal-500" value="${isEdit ? tenant.phone : ''}">
                                </div>
                            </div>
                            <div class="grid grid-cols-2 gap-4">
                                <div>
                                    <label for="entryDate" class="block text-sm font-medium text-slate-700">Tanggal Masuk</label>
                                    <input type="date" id="entryDate" required class="mt-1 block w-full px-3 py-2 bg-white border border-stone-300 rounded-md shadow-sm focus:outline-none focus:ring-teal-500 focus:border-teal-500" value="${entryDateValue}">
                                </div>
                                <div>
                                    <label for="rent_per_month_input" class="block text-sm font-medium text-slate-700">Harga Sewa per Bulan (Rp)</label>
                                    <input type="number" id="rent_per_month_input" required class="mt-1 block w-full px-3 py-2 bg-white border border-stone-300 rounded-md shadow-sm focus:outline-none focus:ring-teal-500 focus:border-teal-500" value="${rentPerMonthValue}">
                                </div>
                            </div>
                            <div>
                                <label for="paymentInterval" class="block text-sm font-medium text-slate-700">Interval Pembayaran</label>
                                <select id="paymentInterval" class="mt-1 block w-full px-3 py-2 bg-white border border-stone-300 rounded-md shadow-sm focus:outline-none focus:ring-teal-500 focus:border-teal-500">
                                    <option value="monthly" ${isEdit && tenant.paymentInterval === 'monthly' ? 'selected' : ''}>Bulanan</option>
                                    <option value="bimonthly" ${isEdit && tenant.paymentInterval === 'bimonthly' ? 'selected' : ''}>2 Bulanan</option>
                                    <option value="quarterly" ${isEdit && tenant.paymentInterval === 'quarterly' ? 'selected' : ''}>3 Bulanan</option>
                                    <option value="fourmonthly" ${isEdit && tenant.paymentInterval === 'fourmonthly' ? 'selected' : ''}>4 Bulanan</option>
                                    <option value="fivemonthly" ${isEdit && tenant.paymentInterval === 'fivemonthly' ? 'selected' : ''}>5 Bulanan</option>
                                    <option value="biannually" ${isEdit && tenant.paymentInterval === 'biannually' ? 'selected' : ''}>6 Bulanan</option>
                                    <option value="annually" ${isEdit && tenant.paymentInterval === 'annually' ? 'selected' : ''}>Tahunan</option>
                                </select>
                            </div>
                            <div>
                                <label for="deposit" class="block text-sm font-medium text-slate-700">Uang Deposit (Rp) <span class="text-slate-500 text-xs">(Opsional)</span></label>
                                <input type="number" id="deposit" placeholder="0" class="mt-1 block w-full px-3 py-2 bg-white border border-stone-300 rounded-md shadow-sm focus:outline-none focus:ring-teal-500 focus:border-teal-500" value="${isEdit ? tenant.deposit : ''}">
                            </div>
                        </div>
                        <div class="mt-6 flex justify-end gap-3">
                            <button data-action="close-modal" class="px-4 py-2 text-sm font-medium text-slate-700 bg-white border border-stone-300 rounded-lg hover:bg-stone-50">Batal</button>
                            <button id="${isEdit ? 'update-tenant-btn' : 'save-tenant-btn'}" data-id="${isEdit ? tenant.id : ''}" class="px-4 py-2 text-sm font-medium text-white bg-teal-600 rounded-lg hover:bg-teal-700">${isEdit ? 'Update' : 'Simpan'}</button>
                        </div>
                    `;
                } else if (type === 'logPayment' && tenant) {
                    const today = new Date();
                    const rentPerMonthValue = rentPerMonth(tenant);
                    const isFirstPayment = tenant.lastPaidPeriodEnd.getTime() === calculateInitialLastPaidPeriodEnd(tenant.entryDate).getTime();
                    const defaultAmount = isFirstPayment ? tenant.rent : rentPerMonthValue;
                    const defaultMonthsToCover = isFirstPayment ? intervalToMonths[tenant.paymentInterval] : 1;

                    let periodText = '';
                    if (isFirstPayment) {
                        periodText = `Sewa Pertama (${paymentIntervalLabels[tenant.paymentInterval]})`;
                    } else {
                        periodText = 'Sewa Bulanan';
                    }

                    title = "Catat Pembayaran";
                    content = `
                        <div class="space-y-4">
                            <div>
                                <label for="payment_tenant_name" class="block text-sm font-medium text-slate-700">Penyewa</label>
                                <input type="text" id="payment_tenant_name" value="${tenant.name} (Kamar ${tenant.room})" class="mt-1 block w-full px-3 py-2 bg-stone-100 border border-stone-300 rounded-md shadow-sm" readonly>
                            </div>
                            <div class="flex items-center gap-2">
                                <label for="payment_date" class="block text-sm font-medium text-slate-700">Tanggal Pembayaran</label>
                                <input type="date" id="payment_date" value="${today.toISOString().split('T')[0]}" required class="mt-1 block px-3 py-2 bg-white border border-stone-300 rounded-md shadow-sm focus:outline-none focus:ring-teal-500 focus:border-teal-500">
                            </div>
                            <div class="mt-4">
                                <label for="payment_amount" class="block text-sm font-medium text-slate-700">Jumlah Bayar (Rp)</label>
                                <input type="number" id="payment_amount" value="${defaultAmount}" required class="mt-1 block w-full px-3 py-2 bg-white border border-stone-300 rounded-md shadow-sm focus:outline-none focus:ring-teal-500 focus:border-teal-500">
                                <p id="months-covered-info" class="text-sm text-slate-500 mt-1">Pembayaran ini mencakup sekitar ${defaultMonthsToCover} bulan.</p>
                            </div>
                            <div>
                                <p class="text-sm font-medium text-slate-700">Info Pembayaran</p>
                                <ul class="text-xs text-slate-600 list-disc list-inside mt-1">
                                    <li>Harga per bulan: ${formatCurrency(rentPerMonthValue)}</li>
                                    <li>Jatuh tempo berikutnya: ${new Intl.DateTimeFormat('id-ID',{day:'2-digit',month:'long',year:'numeric'}).format(getExpectedDueDate(tenant))}</li>
                                    <li>Interval pembayaran: ${paymentIntervalLabels[tenant.paymentInterval]}</li>
                                </ul>
                            </div>
                        </div>
                        <div class="mt-6 flex justify-end gap-3">
                            <button data-action="close-modal" class="px-4 py-2 text-sm font-medium text-slate-700 bg-white border border-stone-300 rounded-lg hover:bg-stone-50">Batal</button>
                            <button id="save-payment-btn" data-id="${tenant.id}" class="px-4 py-2 text-sm font-medium text-white bg-teal-600 rounded-lg hover:bg-teal-700">Simpan Pembayaran</button>
                        </div>
                    `;
                } else if (type === 'confirmDelete' && tenant) {
                    title = "Konfirmasi Penghapusan";
                    content = `
                        <p class="text-slate-700 mb-4">Anda yakin ingin menghapus penghuni <b>${tenant.name} (Kamar ${tenant.room})</b>?</p>
                        <p class="text-sm text-red-600">Tindakan ini tidak dapat dibatalkan dan semua data pembayaran terkait juga akan terhapus.</p>
                        <div class="mt-6 flex justify-end gap-3">
                            <button data-action="close-modal" class="px-4 py-2 text-sm font-medium text-slate-700 bg-white border border-stone-300 rounded-lg hover:bg-stone-50">Batal</button>
                            <button id="confirm-delete-btn" data-id="${tenant.id}" class="px-4 py-2 text-sm font-medium text-white bg-red-600 rounded-lg hover:bg-red-700">Ya, Hapus</button>
                        </div>
                    `;
                } else if (type === 'confirmTerminate' && tenant) {
                    const today = new Date();
                    const defaultTerminationDate = today.toISOString().split('T')[0];

                    title = "Konfirmasi Akhiri Masa Sewa";
                    content = `
                        <p class="text-slate-700 mb-4">Anda akan mengakhiri masa sewa untuk <b>${tenant.name} (Kamar ${tenant.room})</b>.</p>
                        <div class="space-y-4">
                            <div>
                                <label for="terminationDate" class="block text-sm font-medium text-slate-700">Tanggal Berhenti Sewa (Tanggal Efektif Terakhir Sewa)</label>
                                <input type="date" id="terminationDate" required class="mt-1 block w-full px-3 py-2 bg-white border border-stone-300 rounded-md shadow-sm focus:outline-none focus:ring-red-500 focus:border-red-500" value="${defaultTerminationDate}">
                            </div>
                            <p class="text-sm text-red-600">Penyewa akan ditandai **Tidak Aktif** dan tidak akan muncul di daftar pembayaran bulanan berikutnya. Riwayat pembayaran akan tetap tersimpan.</p>
                        </div>
                        <div class="mt-6 flex justify-end gap-3">
                            <button data-action="close-modal" class="px-4 py-2 text-sm font-medium text-slate-700 bg-white border border-stone-300 rounded-lg hover:bg-stone-50">Batal</button>
                            <button id="confirm-terminate-btn" data-id="${tenant.id}" class="px-4 py-2 text-sm font-medium text-white bg-red-600 rounded-lg hover:bg-red-700">Akhiri Sewa</button>
                        </div>
                    `;
                } else if (type === 'addExpense') {
                    title = "Tambah Pengeluaran";
                    content = `
                        <div class="space-y-4">
                            <div>
                                <label for="expense-description" class="block text-sm font-medium text-slate-700">Deskripsi Pengeluaran</label>
                                <input type="text" id="expense-description" required class="mt-1 block w-full px-3 py-2 bg-white border border-stone-300 rounded-md shadow-sm focus:outline-none focus:ring-red-500 focus:border-red-500" placeholder="Contoh: Pembelian galon air">
                            </div>
                            <div>
                                <label for="expense-amount" class="block text-sm font-medium text-slate-700">Jumlah (Rp)</label>
                                <input type="number" id="expense-amount" required class="mt-1 block w-full px-3 py-2 bg-white border border-stone-300 rounded-md shadow-sm focus:outline-none focus:ring-red-500 focus:border-red-500" placeholder="100000">
                            </div>
                            <div>
                                <label for="expense-date" class="block text-sm font-medium text-slate-700">Tanggal Pengeluaran</label>
                                <input type="date" id="expense-date" required class="mt-1 block w-full px-3 py-2 bg-white border border-stone-300 rounded-md shadow-sm focus:outline-none focus:ring-red-500 focus:border-red-500" value="${new Date().toISOString().split('T')[0]}">
                            </div>
                        </div>
                        <div class="mt-6 flex justify-end gap-3">
                            <button data-action="close-modal" class="px-4 py-2 text-sm font-medium text-slate-700 bg-white border border-stone-300 rounded-lg hover:bg-stone-50">Batal</button>
                            <button id="save-expense-btn" class="px-4 py-2 text-sm font-medium text-white bg-red-600 rounded-lg hover:bg-red-700">Simpan Pengeluaran</button>
                        </div>
                    `;
                } else if (type === 'editExpense' && expense) {
                    title = "Edit Pengeluaran";
                    const dateValue = expense.date.toISOString().split('T')[0];
                    content = `
                        <div class="space-y-4">
                            <div>
                                <label for="expense-description" class="block text-sm font-medium text-slate-700">Deskripsi Pengeluaran</label>
                                <input type="text" id="expense-description" required class="mt-1 block w-full px-3 py-2 bg-white border border-stone-300 rounded-md shadow-sm focus:outline-none focus:ring-red-500 focus:border-red-500" value="${expense.description}">
                            </div>
                            <div>
                                <label for="expense-amount" class="block text-sm font-medium text-slate-700">Jumlah (Rp)</label>
                                <input type="number" id="expense-amount" required class="mt-1 block w-full px-3 py-2 bg-white border border-stone-300 rounded-md shadow-sm focus:outline-none focus:ring-red-500 focus:border-red-500" value="${expense.amount}">
                            </div>
                            <div>
                                <label for="expense-date" class="block text-sm font-medium text-slate-700">Tanggal Pengeluaran</label>
                                <input type="date" id="expense-date" required class="mt-1 block w-full px-3 py-2 bg-white border border-stone-300 rounded-md shadow-sm focus:outline-none focus:ring-red-500 focus:border-red-500" value="${dateValue}">
                            </div>
                        </div>
                        <div class="mt-6 flex justify-end gap-3">
                            <button data-action="close-modal" class="px-4 py-2 text-sm font-medium text-slate-700 bg-white border border-stone-300 rounded-lg hover:bg-stone-50">Batal</button>
                            <button id="update-expense-btn" data-id="${expense.id}" class="px-4 py-2 text-sm font-medium text-white bg-red-600 rounded-lg hover:bg-red-700">Simpan Perubahan</button>
                        </div>
                    `;
                } else if (type === 'confirmDeleteExpense' && expense) {
                    title = "Konfirmasi Penghapusan Pengeluaran";
                    content = `
                        <p class="text-slate-700 mb-4">Anda yakin ingin menghapus pengeluaran <b>"${expense.description}"</b> sejumlah <b>${formatCurrency(expense.amount)}</b>?</p>
                        <p class="text-sm text-red-600">Tindakan ini tidak dapat dibatalkan.</p>
                        <div class="mt-6 flex justify-end gap-3">
                            <button data-action="close-modal" class="px-4 py-2 text-sm font-medium text-slate-700 bg-white border border-stone-300 rounded-lg hover:bg-stone-50">Batal</button>
                            <button id="confirm-delete-expense-btn" data-id="${expense.id}" class="px-4 py-2 text-sm font-medium text-white bg-red-600 rounded-lg hover:bg-red-700">Ya, Hapus</button>
                        </div>
                    `;
                }

                const modalHTML = `
                    <div id="modal" class="fixed inset-0 z-50 flex items-center justify-center p-4 modal-bg opacity-0">
                        <div class="bg-white rounded-xl shadow-xl w-full max-w-lg p-6 modal-content transform scale-95">
                            <div class="flex justify-between items-center mb-4">
                                <h3 class="text-lg font-bold text-slate-900">${title}</h3>
                                <button data-action="close-modal" class="text-slate-400 hover:text-slate-600">&times;</button>
                            </div>
                            <div>${content}</div>
                        </div>
                    </div>
                `;
                modalContainer.innerHTML = modalHTML;
                setTimeout(() => {
                    const modal = document.getElementById('modal');
                    modal.classList.remove('opacity-0');
                    modal.querySelector('.modal-content').classList.remove('scale-95');
                }, 10);

                if (type === 'addTenant') {
                    document.getElementById('paymentInterval').value = 'monthly';
                    document.getElementById('entryDate').valueAsDate = new Date();
                }

                if (type === 'logPayment' && tenant) {
                    const paymentAmountInput = document.getElementById('payment_amount');
                    const monthsCoveredInfo = document.getElementById('months-covered-info');

                    const updateMonthsCovered = () => {
                        const amount = parseFloat(paymentAmountInput.value);
                        const rentPerMonthValue = rentPerMonth(tenant);
                        let months = 0;
                        if (!isNaN(amount) && amount > 0 && rentPerMonthValue > 0) {
                            const isFirstPayment = tenant.lastPaidPeriodEnd.getTime() === calculateInitialLastPaidPeriodEnd(tenant.entryDate).getTime();
                            if (isFirstPayment) {
                                months = amount / rentPerMonthValue;
                            } else {
                                months = 1;
                            }
                            const monthsText = months.toLocaleString('id-ID', {
                                minimumFractionDigits: 0,
                                maximumFractionDigits: 2
                            });
                            monthsCoveredInfo.textContent = `Pembayaran ini mencakup sekitar ${monthsText} bulan.`;
                        } else {
                            monthsCoveredInfo.textContent = '';
                        }
                    };

                    paymentAmountInput.addEventListener('input', updateMonthsCovered);
                    updateMonthsCovered();
                }
            };

            const closeModal = () => {
                const modal = document.getElementById('modal');
                if (modal) {
                    modal.classList.add('opacity-0');
                    modal.querySelector('.modal-content').classList.add('scale-95');
                    setTimeout(() => {
                        document.getElementById('modal-container').innerHTML = '';
                    }, 300);
                }
            };

            // --- EVENTS ---
            const handleFilterClick = (e) => {
                const btn = e.target.closest('.filter-btn');
                if (!btn) return;
                currentFilter = btn.dataset.filter;
                document.querySelectorAll('.filter-btn').forEach(b => {
                    b.classList.remove('bg-teal-600', 'text-white');
                    b.classList.add('bg-white', 'text-slate-700');
                });
                btn.classList.add('bg-teal-600', 'text-white');
                btn.classList.remove('bg-white', 'text-slate-700');
                renderTable();
                renderMetricsCards();
            };

            const handleTableClick = (e) => {
                const action = e.target.dataset.action;
                const id = parseInt(e.target.dataset.id);
                if (!action) return;
                if (action === 'log-payment') {
                    renderModal('logPayment', id);
                } else if (action === 'edit-tenant') {
                    renderModal('editTenant', id);
                } else if (action === 'delete-tenant') {
                    renderModal('confirmDelete', id);
                } else if (action === 'terminate-tenant') {
                    renderModal('confirmTerminate', id);
                } else if (action === 'reactivate-tenant') {
                    handleReactivateTenant(id);
                } else if (action === 'edit-expense') {
                    renderModal('editExpense', id);
                } else if (action === 'delete-expense') {
                    renderModal('confirmDeleteExpense', id);
                } else if (action === 'download-nota') {
                    generateNotaPDF(id);
                }
            };

            const handleReactivateTenant = (id) => {
                const tenantIndex = tenants.findIndex(t => t.id === id);
                if (tenantIndex !== -1) {
                    tenants[tenantIndex].isActive = true;
                    tenants[tenantIndex].terminationDate = null;
                    saveData();
                    updateAll();
                    alert(`Penyewa ${tenants[tenantIndex].name} diaktifkan kembali.`)
                }
            };

            const handleModalAction = (e) => {
                const action = e.target.dataset.action;
                if (action === 'close-modal') {
                    closeModal();
                    return;
                }

                const btnId = e.target.id;

                if (btnId === 'save-tenant-btn') {
                    const name = document.getElementById('name').value.trim();
                    const room = document.getElementById('room').value.trim();
                    const phone = document.getElementById('phone').value.trim();
                    const entryDateStr = document.getElementById('entryDate').value;
                    const rentPerMonthInput = parseFloat(document.getElementById('rent_per_month_input').value);
                    const deposit = parseFloat(document.getElementById('deposit').value) || 0;
                    const paymentInterval = document.getElementById('paymentInterval').value;
                    const rent = rentPerMonthInput * (intervalToMonths[paymentInterval] || 1);

                    if (name && room && phone && entryDateStr && !isNaN(rentPerMonthInput) && paymentInterval) {
                        const entryDate = new Date(entryDateStr);
                        entryDate.setHours(0, 0, 0, 0);

                        const newTenant = {
                            id: tenants.length > 0 ? Math.max(...tenants.map(t => t.id)) + 1 : 1,
                            name,
                            room,
                            phone,
                            entryDate,
                            rent,
                            deposit,
                            paymentInterval,
                            lastPaidPeriodEnd: calculateInitialLastPaidPeriodEnd(entryDate),
                            isActive: true,
                            terminationDate: null
                        };
                        tenants.push(newTenant);
                        saveData();
                        updateAll();
                        closeModal();
                    } else {
                        alert("Harap isi semua kolom wajib (Nama, Kamar, No. WA, Tanggal Masuk, Harga/Bulan, Interval) dengan benar.");
                    }
                } else if (btnId === 'update-tenant-btn') {
                    const tenantId = parseInt(e.target.dataset.id);
                    const tenantIndex = tenants.findIndex(t => t.id === tenantId);
                    if (tenantIndex === -1) {
                        alert("Penyewa tidak ditemukan.");
                        return;
                    }

                    const name = document.getElementById('name').value.trim();
                    const room = document.getElementById('room').value.trim();
                    const phone = document.getElementById('phone').value.trim();
                    const entryDateStr = document.getElementById('entryDate').value;
                    const rentPerMonthInput = parseFloat(document.getElementById('rent_per_month_input').value);
                    const deposit = parseFloat(document.getElementById('deposit').value) || 0;
                    const paymentInterval = document.getElementById('paymentInterval').value;
                    const rent = rentPerMonthInput * (intervalToMonths[paymentInterval] || 1);

                    if (name && room && phone && entryDateStr && !isNaN(rentPerMonthInput) && paymentInterval) {
                        const updatedEntryDate = new Date(entryDateStr);
                        updatedEntryDate.setHours(0, 0, 0, 0);

                        const entryDateChanged = updatedEntryDate.getTime() !== tenants[tenantIndex].entryDate.getTime();

                        tenants[tenantIndex].name = name;
                        tenants[tenantIndex].room = room;
                        tenants[tenantIndex].phone = phone;
                        tenants[tenantIndex].entryDate = updatedEntryDate;
                        tenants[tenantIndex].rent = rent;
                        tenants[tenantIndex].deposit = deposit;
                        tenants[tenantIndex].paymentInterval = paymentInterval;

                        if (entryDateChanged) {
                             tenants[tenantIndex].lastPaidPeriodEnd = calculateInitialLastPaidPeriodEnd(updatedEntryDate);
                        }

                        saveData();
                        updateAll();
                        closeModal();
                    } else {
                        alert("Harap isi semua kolom wajib dengan benar.");
                    }
                } else if (btnId === 'save-payment-btn') {
                    const tenantId = parseInt(e.target.dataset.id);
                    const tenantIndex = tenants.findIndex(t => t.id === tenantId);
                    if (tenantIndex === -1) {
                        alert("Penyewa tidak ditemukan.");
                        return;
                    }
                    const tenant = tenants[tenantIndex];

                    const paymentAmount = parseFloat(document.getElementById('payment_amount').value);
                    const paymentDateStr = document.getElementById('payment_date').value;
                    const paymentDate = new Date(paymentDateStr);
                    paymentDate.setHours(0, 0, 0, 0);

                    if (!isNaN(paymentAmount) && paymentDateStr) {
                        let monthsToAdvance = 0;
                        const isFirstPayment = tenant.lastPaidPeriodEnd.getTime() === calculateInitialLastPaidPeriodEnd(tenant.entryDate).getTime();

                        if (isFirstPayment) {
                            monthsToAdvance = intervalToMonths[tenant.paymentInterval];
                        } else {
                            monthsToAdvance = 1;
                        }

                        // === FIX: Hitung periode mulai dari 1 hari SETELAH lastPaidPeriodEnd,
                        // lalu maju N bulan, lalu mundur 1 hari untuk akhir periode ===
                        let periodStart;
                        if (tenant.lastPaidPeriodEnd) {
                            periodStart = new Date(tenant.lastPaidPeriodEnd);
                        } else {
                            periodStart = new Date(calculateInitialLastPaidPeriodEnd(tenant.entryDate));
                        }
                        periodStart.setDate(periodStart.getDate() + 1);
                        periodStart.setHours(0, 0, 0, 0);

                        let newLastPaidPeriodEnd = addMonths(periodStart, monthsToAdvance);
                        newLastPaidPeriodEnd.setDate(newLastPaidPeriodEnd.getDate() - 1);
                        newLastPaidPeriodEnd.setHours(23, 59, 59, 999);
                        // === END FIX ===

                        payments.push({
                            id: payments.length > 0 ? Math.max(...payments.map(p => p.id)) + 1 : 1,
                            tenantId,
                            periodEndCovered: newLastPaidPeriodEnd,
                            amount: paymentAmount,
                            date: paymentDate,
                            paidForInterval: tenant.paymentInterval
                        });
                        tenant.lastPaidPeriodEnd = newLastPaidPeriodEnd;

                        saveData();
                        updateAll();
                        closeModal();
                    } else {
                        alert("Harap isi jumlah dan tanggal pembayaran dengan benar.");
                    }
                } else if (btnId === 'confirm-delete-btn') {
                    const tenantToDeleteId = parseInt(e.target.dataset.id);
                    tenants = tenants.filter(t => t.id !== tenantToDeleteId);
                    payments = payments.filter(p => p.tenantId !== tenantToDeleteId);
                    saveData();
                    updateAll();
                    closeModal();
                } else if (btnId === 'confirm-terminate-btn') {
                    const tenantId = parseInt(e.target.dataset.id);
                    const tenantIndex = tenants.findIndex(t => t.id === tenantId);
                    const terminationDateStr = document.getElementById('terminationDate').value;

                    if (tenantIndex !== -1 && terminationDateStr) {
                        const terminationDate = new Date(terminationDateStr);
                        terminationDate.setHours(23, 59, 59, 999);

                        tenants[tenantIndex].isActive = false;
                        tenants[tenantIndex].terminationDate = terminationDate;
                        saveData();
                        updateAll();
                        closeModal();
                    } else {
                        alert("Harap pilih tanggal berhenti sewa.");
                    }
                } else if (btnId === 'save-expense-btn') {
                    const description = document.getElementById('expense-description').value.trim();
                    const amount = parseFloat(document.getElementById('expense-amount').value);
                    const dateStr = document.getElementById('expense-date').value;
                    const date = new Date(dateStr);
                    date.setHours(0, 0, 0, 0);

                    if (description && !isNaN(amount) && amount > 0 && dateStr) {
                        const newExpense = {
                            id: expenses.length > 0 ? Math.max(...expenses.map(e => e.id)) + 1 : 1,
                            description,
                            amount,
                            date
                        };
                        expenses.push(newExpense);
                        saveData();
                        updateAll();
                        closeModal();
                    } else {
                        alert("Harap isi semua kolom dengan benar. Jumlah harus lebih dari 0.");
                    }
                } else if (btnId === 'update-expense-btn') {
                    const expenseId = parseInt(e.target.dataset.id);
                    const expenseIndex = expenses.findIndex(e => e.id === expenseId);
                    if (expenseIndex === -1) {
                        alert("Pengeluaran tidak ditemukan.");
                        return;
                    }

                    const description = document.getElementById('expense-description').value.trim();
                    const amount = parseFloat(document.getElementById('expense-amount').value);
                    const dateStr = document.getElementById('expense-date').value;
                    const date = new Date(dateStr);
                    date.setHours(0, 0, 0, 0);

                    if (description && !isNaN(amount) && amount > 0 && dateStr) {
                        expenses[expenseIndex].description = description;
                        expenses[expenseIndex].amount = amount;
                        expenses[expenseIndex].date = date;

                        saveData();
                        updateAll();
                        closeModal();
                    } else {
                        alert("Harap isi semua kolom dengan benar. Jumlah harus lebih dari 0.");
                    }
                } else if (btnId === 'confirm-delete-expense-btn') {
                    const expenseToDeleteId = parseInt(e.target.dataset.id);
                    expenses = expenses.filter(e => e.id !== expenseToDeleteId);
                    saveData();
                    updateAll();
                    closeModal();
                }
            };

            const handlePeriodFilter = () => {
                const month = parseInt(document.getElementById('month-select').value);
                const year = parseInt(document.getElementById('year-select').value);
                currentSelectedDate = new Date(year, month, 1);
                updateAll();
            };

            // --- INIT ---
            const updateAll = () => {
                renderMetricsCards();
                renderTable();
                renderExpenseTable();
            };

            loadData();
            populateMonthYearSelectors();
            document.getElementById('filters').addEventListener('click', handleFilterClick);
            document.getElementById('tenant-table-body').addEventListener('click', handleTableClick);
            document.getElementById('expense-table-body').addEventListener('click', handleTableClick);
            document.getElementById('modal-container').addEventListener('click', handleModalAction);
            document.getElementById('add-tenant-btn').addEventListener('click', () => renderModal('addTenant'));
            document.getElementById('add-expense-btn').addEventListener('click', () => renderModal('addExpense'));
            document.getElementById('apply-period-filter').addEventListener('click', handlePeriodFilter);
            document.getElementById('download-excel-btn').addEventListener('click', downloadExcel);

            updateAll();

        function generateNotaPDF(tenantId) {
            const jsPDF = window.jspdf.jsPDF;

            const tenant = tenants.find(t => t.id === tenantId);
            if (!tenant) return;

            const paymentsTenant = payments
                .filter(p => p.tenantId === tenantId)
                .sort((a, b) => b.date - a.date);

            if (paymentsTenant.length === 0) {
                alert("Belum ada pembayaran untuk penyewa ini.");
                return;
            }

            const lastPayment = paymentsTenant[0];

            // ===============================
            // AMBIL LANGSUNG DARI KOLOM TABEL
            // ===============================
            const statusData = getTenantPaymentStatus(tenant, currentSelectedDate);

            const jatuhTempoDate = statusData.dueDate;
            const jatuhTempoText = jatuhTempoDate
                ? new Intl.DateTimeFormat('id-ID', {
                    day: '2-digit',
                    month: 'long',
                    year: 'numeric'
                }).format(jatuhTempoDate)
                : '-';

            // ===============================
            // INTERVAL (TAMPIL SAJA)
            // ===============================
            const intervalText = paymentIntervalLabels[tenant.paymentInterval] || '-';

            // ===============================
            // STATUS (SAMA DENGAN TABEL)
            // ===============================
            const statusText = statusData.isPaid ? "LUNAS" : "BELUM LUNAS";

            // ===============================
            // PDF
            // ===============================
            const doc = new jsPDF({
                unit: "mm",
                format: [80, 140]
            });

            let y = 8;

            doc.setFont("courier", "bold");
            doc.setFontSize(10);
            doc.text(
                "KWITANSI PEMBAYARAN\nKOST BAROKFI PUTRA & PUTRI",
                40,
                y,
                { align: "center" }
            );

            y += 10;
            doc.setFontSize(9);
            doc.setFont("courier", "normal");
            doc.text("----------------------------------------", 40, y, { align: "center" });

            // DATA PENYEWA
            y += 6;
            doc.text(`Nama   : ${tenant.name}`, 5, y);
            y += 5;
            doc.text(`Kamar  : ${tenant.room}`, 5, y);
            y += 5;
            doc.text(`No WA  : ${tenant.phone}`, 5, y);

            y += 6;
            doc.text("----------------------------------------", 40, y, { align: "center" });

            // DATA PEMBAYARAN
            const intervalMonths = intervalToMonths[tenant.paymentInterval] || 1;
            const hargaPerBulan = tenant.rent / intervalMonths;

            y += 6;
            doc.text(`Tanggal Bayar : ${lastPayment.date.toLocaleDateString('id-ID')}`, 5, y);
            y += 5;
            doc.text(`Jumlah Bayar  : ${formatCurrency(lastPayment.amount)}`, 5, y);
            y += 5;
            doc.text(`Harga / Bulan : ${formatCurrency(hargaPerBulan)}`, 5, y);
            y += 5;
            doc.text(`Interval      : ${intervalText}`, 5, y);
            y += 5;
            doc.text(`Jatuh Tempo   : ${jatuhTempoText}`, 5, y);

            // STATUS
            y += 7;
            doc.setFont("courier", "bold");
            doc.text(`STATUS : ${statusText}`, 5, y);

            y += 8;
            doc.setFont("courier", "normal");
            doc.text("----------------------------------------", 40, y, { align: "center" });

            // FOOTER
            y += 6;
            doc.text("Terima kasih atas pembayarannya", 40, y, { align: "center" });

            y += 10;
            doc.setFontSize(8);
            doc.text("Pemilik Kost", 75, y, { align: "right" });
            y += 10;
            doc.setFont("courier", "bold");
            doc.text("Eko Prasetyo", 75, y, { align: "right" });

            doc.save(`Nota_Kost_${tenant.name}_Kmr_${tenant.room}.pdf`);
        }

            function drawLunasStamp(doc, x, y) {
            doc.saveGraphicsState();

            // Warna merah cap
            doc.setTextColor(200, 0, 0);
            doc.setDrawColor(200, 0, 0);
            doc.setLineWidth(0.8);

            // Rotasi cap
            doc.rotate(-20, { origin: [x, y] });

            // Kotak cap
            doc.rect(x - 18, y - 6, 36, 12);

            // Teks LUNAS
            doc.setFont("courier", "bold");
            doc.setFontSize(14);
            doc.text("LUNAS", x, y + 4, { align: "center" });

            doc.restoreGraphicsState();

            // Reset warna
            doc.setTextColor(0, 0, 0);
        }
        });
    </script>
</body>

</html>
