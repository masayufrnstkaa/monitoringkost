<!DOCTYPE html>
<html lang="id">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dasbor Manajemen Kost Barokfi</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        
        .modal-bg {
            background-color: rgba(0, 0, 0, 0.5);
            transition: opacity 0.3s ease;
        }
        
        .modal-content {
            transition: transform 0.3s ease;
        }
    </style>
</head>

<body class="bg-stone-50 text-slate-800">

    <div id="app" class="container mx-auto p-4 sm:p-6 lg:p-8">

        <header class="mb-8">
            <h1 class="text-3xl font-bold text-slate-900">Dasbor Manajemen Kost Barokfi</h1>
            <p class="text-slate-600 mt-1">Selamat datang! Pantau status pembayaran dan keuangan kos Anda di sini.</p>
        </header>

        <div class="flex justify-end mb-6 gap-3">
            <button id="download-excel-btn" class="bg-green-600 text-white rounded-lg px-6 py-3 shadow-lg hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500 transition flex items-center gap-2">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                    <path fill-rule="evenodd" d="M3 17a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zm3.293-7.707a1 1 0 011.414 0L9 10.586V3a1 1 0 112 0v7.586l1.293-1.293a1 1 0 111.414 1.414l-3 3a1 1 0 01-1.414 0l-3-3a1 1 0 010-1.414z" clip-rule="evenodd" />
                </svg>
                Download Data (Excel)
            </button>
            <button id="add-tenant-btn" class="bg-teal-600 text-white rounded-lg px-6 py-3 shadow-lg hover:bg-teal-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-teal-500 transition flex items-center gap-2">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6" />
                </svg>
                Tambah Penyewa Baru
            </button>
        </div>

        <main>
            <section id="key-metrics" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6 mb-8">
                <div class="bg-white p-6 rounded-xl border border-stone-200 shadow-sm">
                    <h3 class="text-sm font-medium text-slate-500">Total Pemasukan (Bulan Ini)</h3>
                    <p id="metric-income" class="text-2xl font-semibold text-teal-600 mt-2">Rp 0</p>
                </div>
                <div class="bg-white p-6 rounded-xl border border-stone-200 shadow-sm">
                    <h3 class="text-sm font-medium text-slate-500">Tunggakan (Belum Lunas)</h3>
                    <p id="metric-due" class="text-2xl font-semibold text-amber-600 mt-2">Rp 0</p>
                </div>
                <div class="bg-white p-6 rounded-xl border border-stone-200 shadow-sm">
                    <h3 class="text-sm font-medium text-slate-500">Okupansi Kamar</h3>
                    <p id="metric-occupancy" class="text-2xl font-semibold text-slate-800 mt-2">0 / 0</p>
                </div>
            </section>

            <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                <div class="lg:col-span-2 bg-white p-6 rounded-xl border border-stone-200 shadow-sm">
                    <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-6 gap-4">
                        <h2 class="text-xl font-bold text-slate-900">Status Pembayaran</h2>
                        <div id="filters" class="flex items-center gap-2 flex-wrap">
                            <button data-filter="all" class="filter-btn bg-teal-600 text-white px-4 py-2 text-sm font-medium rounded-lg shadow-sm">Semua</button>
                            <button data-filter="unpaid" class="filter-btn bg-white text-slate-700 px-4 py-2 text-sm font-medium rounded-lg border border-stone-300">Belum Lunas</button>
                            <button data-filter="due_soon" class="filter-btn bg-white text-slate-700 px-4 py-2 text-sm font-medium rounded-lg border border-stone-300">Jatuh Tempo</button>
                            <button data-filter="paid" class="filter-btn bg-white text-slate-700 px-4 py-2 text-sm font-medium rounded-lg border border-stone-300">Lunas</button>
                        </div>
                    </div>

                    <div class="flex items-center gap-2 mb-4">
                        <label for="month-select" class="text-sm font-medium text-slate-700">Bulan:</label>
                        <select id="month-select" class="px-3 py-2 text-sm rounded-lg border border-stone-300 bg-white"></select>
                        <label for="year-select" class="text-sm font-medium text-slate-700">Tahun:</label>
                        <select id="year-select" class="px-3 py-2 text-sm rounded-lg border border-stone-300 bg-white"></select>
                        <button id="apply-period-filter" class="bg-teal-600 text-white px-4 py-2 text-sm font-medium rounded-lg shadow-sm hover:bg-teal-700">Terapkan</button>
                    </div>

                    <div class="overflow-x-auto">
                        <table class="w-full text-sm text-left text-slate-600">
                            <thead class="text-xs text-slate-700 uppercase bg-stone-50">
                                <tr>
                                    <th scope="col" class="px-6 py-3">Penyewa</th>
                                    <th scope="col" class="px-6 py-3">Deposit</th>
                                    <th scope="col" class="px-6 py-3">Interval</th>
                                    <th scope="col" class="px-6 py-3">Jatuh Tempo</th>
                                    <th scope="col" class="px-6 py-3">Status</th>
                                    <th scope="col" class="px-6 py-3 text-center">Aksi</th>
                                    <th scope="col" class="px-6 py-3 text-center">Hapus</th>
                                </tr>
                            </thead>
                            <tbody id="tenant-table-body">
                            </tbody>
                        </table>
                        <p id="empty-state" class="text-center py-12 text-slate-500 hidden">Tidak ada data untuk filter yang dipilih.</p>
                    </div>
                </div>

                <div class="bg-white p-6 rounded-xl border border-stone-200 shadow-sm">
                    <h2 class="text-xl font-bold text-slate-900 mb-2">Ringkasan Pembayaran</h2>
                    <p class="text-sm text-slate-500 mb-6">Visualisasi status pembayaran penyewa bulan ini.</p>
                    <div class="chart-container relative h-64 md:h-72 lg:h-80 w-full max-w-sm mx-auto">
                        <canvas id="payment-chart"></canvas>
                    </div>
                </div>
            </div>
        </main>

    </div>

    <div id="modal-container"></div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {

                    // --- DATA ---
                    const NAMA_KOS = "Barokfi Kost Putra dan Putri"; // Ubah ini dengan nama kos Anda
                    let tenants = []; // Data penghuni
                    let payments = []; // Data pembayaran

                    let currentFilter = 'all';
                    let paymentChart;

                    const monthNames = [
                        "Januari", "Februari", "Maret", "April", "Mei", "Juni",
                        "Juli", "Agustus", "September", "Oktober", "November", "Desember"
                    ];

                    const paymentIntervalLabels = {
                        "monthly": "Bulanan",
                        "quarterly": "3 Bulanan",
                        "biannually": "6 Bulanan",
                        "annually": "Tahunan"
                    };

                    let currentSelectedDate = new Date(); // Default ke tanggal saat ini
                    currentSelectedDate.setDate(1); // Atur ke hari pertama bulan untuk perhitungan periode yang konsisten

                    // --- FUNGSI LOCAL STORAGE ---
                    const saveData = () => {
                        try {
                            localStorage.setItem('tenantsData', JSON.stringify(tenants));
                            localStorage.setItem('paymentsData', JSON.stringify(payments));
                            console.log('Data disimpan ke LocalStorage.');
                        } catch (e) {
                            console.error('Kesalahan saat menyimpan data ke LocalStorage:', e);
                            alert('Gagal menyimpan data ke penyimpanan lokal. Pastikan ruang penyimpanan tersedia.');
                        }
                    };

                    const loadData = () => {
                        try {
                            const savedTenants = localStorage.getItem('tenantsData');
                            const savedPayments = localStorage.getItem('paymentsData');
                            if (savedTenants) {
                                tenants = JSON.parse(savedTenants);
                                // Konversi string entryDate dan lastPaidPeriodEnd kembali ke objek Date
                                tenants.forEach(tenant => {
                                    if (typeof tenant.entryDate === 'string') {
                                        tenant.entryDate = new Date(tenant.entryDate);
                                    }
                                    if (typeof tenant.lastPaidPeriodEnd === 'string') {
                                        tenant.lastPaidPeriodEnd = new Date(tenant.lastPaidPeriodEnd);
                                    } else if (tenant.lastPaidPeriodEnd === undefined) {
                                        // Jika lastPaidPeriodEnd belum ada (dari data lama), inisialisasi dengan tanggal masuk
                                        // Ini penting untuk perhitungan jatuh tempo awal
                                        tenant.lastPaidPeriodEnd = new Date(tenant.entryDate);
                                        tenant.lastPaidPeriodEnd.setDate(tenant.lastPaidPeriodEnd.getDate() - 1); // Set to day before entry for correct initial due
                                    }
                                    // Pastikan deposit ada dan berupa angka, default ke 0 jika tidak ada atau tidak valid
                                    tenant.deposit = tenant.deposit ? parseFloat(tenant.deposit) : 0;
                                    // Pastikan paymentInterval ada, default ke 'monthly' jika tidak ada
                                    tenant.paymentInterval = tenant.paymentInterval || 'monthly';
                                });
                            }
                            if (savedPayments) {
                                payments = JSON.parse(savedPayments);
                                // Konversi string tanggal pembayaran kembali ke objek Date
                                payments.forEach(payment => {
                                    if (typeof payment.date === 'string') {
                                        payment.date = new Date(payment.date);
                                    }
                                });
                            }
                            console.log('Data dimuat dari LocalStorage.');
                        } catch (e) {
                            console.error('Kesalahan saat memuat data dari LocalStorage:', e);
                            alert('Gagal memuat data dari penyimpanan lokal. Data mungkin rusak.');
                        }
                    };

                    // --- FUNGSI UTILITAS ---
                    const formatCurrency = (amount) => `Rp ${new Intl.NumberFormat('id-ID').format(amount)}`;

                    const addMonths = (date, months) => {
                        const d = new Date(date);
                        d.setMonth(d.getMonth() + months);
                        // Handle cases where the original day doesn't exist in the new month
                        if (d.getDate() !== date.getDate() && d.getMonth() !== (date.getMonth() + months) % 12) {
                            d.setDate(0); // Set to last day of previous month
                        }
                        return d;
                    };

                    const getExpectedDueDate = (tenant) => {
                        let dueDate = new Date(tenant.lastPaidPeriodEnd);
                        dueDate.setDate(dueDate.getDate() + 1); // Start from the day after last paid period ends

                        switch (tenant.paymentInterval) {
                            case 'monthly':
                                // If payment interval is monthly, due date is next month's entryDate
                                return getDueDateForPeriod(tenant.entryDate, dueDate.getMonth(), dueDate.getFullYear());
                            case 'quarterly':
                                // Add 3 months to the month of the entry date, adjust year if needed
                                let nextQuarterDate = addMonths(tenant.entryDate, 3);
                                // Align nextQuarterDate to be after lastPaidPeriodEnd if tenant has already paid up to some point
                                while (nextQuarterDate <= tenant.lastPaidPeriodEnd) {
                                    nextQuarterDate = addMonths(nextQuarterDate, 3);
                                }
                                return getDueDateForPeriod(tenant.entryDate, nextQuarterDate.getMonth(), nextQuarterDate.getFullYear());
                            case 'biannually':
                                let nextHalfYearDate = addMonths(tenant.entryDate, 6);
                                while (nextHalfYearDate <= tenant.lastPaidPeriodEnd) {
                                    nextHalfYearDate = addMonths(nextHalfYearDate, 6);
                                }
                                return getDueDateForPeriod(tenant.entryDate, nextHalfYearDate.getMonth(), nextHalfYearDate.getFullYear());
                            case 'annually':
                                let nextYearDate = addMonths(tenant.entryDate, 12);
                                while (nextYearDate <= tenant.lastPaidPeriodEnd) {
                                    nextYearDate = addMonths(nextYearDate, 12);
                                }
                                return getDueDateForPeriod(tenant.entryDate, nextYearDate.getMonth(), nextYearDate.getFullYear());
                            default:
                                return getDueDateForPeriod(tenant.entryDate, dueDate.getMonth(), dueDate.getFullYear()); // Default ke bulanan
                        }
                    };

                    const getDueDateForPeriod = (entryDateObj, targetMonthIndex, targetYear) => {
                        let dueDate = new Date(targetYear, targetMonthIndex, entryDateObj.getDate());

                        // If setting the date results in a different month, it means the entryDate.getDate() was too high
                        // for the target month (e.g., 31st in February). Set it to the last day of the target month.
                        if (dueDate.getMonth() !== targetMonthIndex) {
                            dueDate = new Date(targetYear, targetMonthIndex + 1, 0); // Setting day to 0 gets the last day of the previous month (targetMonthIndex + 1)
                        }
                        return dueDate;
                    };


                    const getTenantPaymentStatus = (tenant, selectedDate) => {
                        const targetMonth = selectedDate.getMonth();
                        const targetYear = selectedDate.getFullYear();
                        const periodDisplay = new Intl.DateTimeFormat('id-ID', {
                            month: 'long',
                            year: 'numeric'
                        }).format(selectedDate);

                        const entryDate = new Date(tenant.entryDate); // Pastikan ini adalah objek Date

                        // Tanggal jatuh tempo berikutnya berdasarkan interval pembayaran
                        let expectedDueDate = getExpectedDueDate(tenant);
                        expectedDueDate.setHours(0, 0, 0, 0); // Normalize to start of day

                        const today = new Date();
                        today.setHours(0, 0, 0, 0);

                        let status, statusText, statusColor;
                        let isPaidForCurrentPeriod = false; // Status apakah sudah lunas untuk periode yang *sedang* diperiksa (bukan hanya untuk bulan yang lewat)

                        // Periksa apakah tenant baru masuk di bulan yang dipilih dan belum ada pembayaran
                        const isEntryMonth = (targetYear === entryDate.getFullYear() && targetMonth === entryDate.getMonth());

                        // Jika selectedDate lebih awal dari tanggal masuk, anggap belum masuk
                        if (selectedDate.getTime() < entryDate.setDate(1) && selectedDate.getMonth() < entryDate.getMonth()) {
                            return {
                                ...tenant,
                                periodDisplay,
                                dueDate: null,
                                totalPaid: 0,
                                isPaid: false,
                                status: 'not_yet_entered',
                                statusText: `Penyewa belum masuk`,
                                statusColor: 'bg-stone-200 text-stone-700',
                                diffDays: null
                            };
                        }

                        // Cek apakah pembayaran sudah dilakukan untuk periode yang relevan dengan `selectedDate`
                        // Kita perlu membandingkan `selectedDate` dengan `lastPaidPeriodEnd`
                        if (tenant.lastPaidPeriodEnd && selectedDate <= tenant.lastPaidPeriodEnd) {
                            isPaidForCurrentPeriod = true;
                        }

                        const diffTime = expectedDueDate.getTime() - today.getTime();
                        const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));

                        if (isPaidForCurrentPeriod) {
                            status = 'paid';
                            statusText = 'Lunas';
                            statusColor = 'bg-teal-100 text-teal-800';
                        } else {
                            if (isEntryMonth && today < expectedDueDate) { // Bulan pertama dan belum jatuh tempo
                                status = 'first_month_unpaid';
                                statusText = 'Bulan pertama penyewa masuk';
                                statusColor = 'bg-blue-100 text-blue-800';
                            } else if (diffDays < 0) {
                                status = 'overdue';
                                statusText = `Terlambat ${Math.abs(diffDays)} hari`;
                                statusColor = 'bg-red-100 text-red-800';
                            } else if (diffDays === 0) {
                                status = 'due_soon';
                                statusText = `Jatuh tempo Hari Ini`;
                                statusColor = 'bg-amber-100 text-amber-800';
                            } else if (diffDays > 0 && diffDays <= 7) { // Beri toleransi lebih untuk jatuh tempo segera (misal 7 hari)
                                status = 'due_soon';
                                statusText = `Jatuh tempo dalam ${diffDays} hari`;
                                statusColor = 'bg-amber-100 text-amber-800';
                            } else {
                                status = 'unpaid';
                                statusText = 'Belum Lunas';
                                statusColor = 'bg-stone-100 text-stone-800';
                            }
                        }

                        // Untuk totalPaid, kita hanya menghitung pembayaran yang dicatat untuk periode terakhir
                        // Ini bisa disederhanakan atau diperluas jika ingin melihat riwayat pembayaran per periode spesifik
                        const relevantPayments = payments
                            .filter(p => p.tenantId === tenant.id && new Date(p.date) >= tenant.lastPaidPeriodEnd) // Misal: pembayaran setelah periode terakhir lunas
                            .reduce((sum, p) => sum + p.amount, 0);

                        return {
                            ...tenant,
                            periodDisplay,
                            dueDate: expectedDueDate,
                            totalPaid: relevantPayments,
                            isPaid: isPaidForCurrentPeriod, // Gunakan status yang lebih spesifik untuk tabel
                            status,
                            statusText,
                            statusColor,
                            diffDays
                        };
                    };

                    // --- FUNGSI UNDUH EXCEL ---
                    const downloadExcel = () => {
                        const dataToDownload = [];

                        // Add header row
                        dataToDownload.push([
                            'Nama Penyewa',
                            'No. Kamar',
                            'No. WA',
                            'Tanggal Masuk',
                            'Harga Sewa (Rp)',
                            'Uang Deposit (Rp)',
                            'Interval Pembayaran',
                            `Status Pembayaran (${monthNames[currentSelectedDate.getMonth()]} ${currentSelectedDate.getFullYear()})`,
                            `Jatuh Tempo Pembayaran Berikutnya`,
                            'Tanggal Akhir Periode Terakhir Dibayar'
                        ]);

                        // Add tenant data
                        tenants.forEach(tenant => {
                            const statusData = getTenantPaymentStatus(tenant, currentSelectedDate);
                            dataToDownload.push([
                                tenant.name,
                                tenant.room,
                                tenant.phone,
                                new Date(tenant.entryDate).toLocaleDateString('id-ID'), // Format entry date
                                tenant.rent,
                                tenant.deposit,
                                paymentIntervalLabels[tenant.paymentInterval],
                                statusData.statusText,
                                statusData.dueDate ? new Date(statusData.dueDate).toLocaleDateString('id-ID') : '-',
                                tenant.lastPaidPeriodEnd ? new Date(tenant.lastPaidPeriodEnd).toLocaleDateString('id-ID') : '-'
                            ]);
                        });

                        let csvContent = dataToDownload.map(e => e.join(",")).join("\n");
                        const blob = new Blob([csvContent], {
                            type: 'text/csv;charset=utf-8;'
                        });
                        const link = document.createElement("a");
                        const url = URL.createObjectURL(blob);
                        link.setAttribute("href", url);
                        link.setAttribute("download", `data_penyewa_kos_${monthNames[currentSelectedDate.getMonth()]}_${currentSelectedDate.getFullYear()}.csv`);
                        link.style.visibility = 'hidden';
                        document.body.appendChild(link);
                        link.click();
                        document.body.removeChild(link);
                    };


                    // --- FUNGSI RENDER ---
                    const populateMonthYearSelectors = () => {
                        const monthSelect = document.getElementById('month-select');
                        const yearSelect = document.getElementById('year-select');
                        const currentYear = new Date().getFullYear();

                        monthSelect.innerHTML = '';
                        yearSelect.innerHTML = '';

                        monthNames.forEach((name, index) => {
                            const option = document.createElement('option');
                            option.value = index;
                            option.textContent = name;
                            if (index === currentSelectedDate.getMonth()) {
                                option.selected = true;
                            }
                            monthSelect.appendChild(option);
                        });

                        for (let i = currentYear - 2; i <= currentYear + 5; i++) {
                            const option = document.createElement('option');
                            option.value = i;
                            option.textContent = i;
                            if (i === currentSelectedDate.getFullYear()) {
                                option.selected = true;
                            }
                            yearSelect.appendChild(option);
                        }
                    };

                    const renderTable = () => {
                            const tableBody = document.getElementById('tenant-table-body');
                            const emptyState = document.getElementById('empty-state');
                            tableBody.innerHTML = '';

                            const processedTenants = tenants.map(t => getTenantPaymentStatus(t, currentSelectedDate));

                            const filteredTenants = processedTenants.filter(t => {
                                if (t.status === 'not_yet_entered') return false; // Sembunyikan penyewa yang belum masuk untuk filter apa pun
                                if (currentFilter === 'all') return true;
                                if (currentFilter === 'paid') return t.isPaid;
                                // For 'unpaid', include 'overdue', 'unpaid', and 'first_month_unpaid' statuses
                                if (currentFilter === 'unpaid') return !t.isPaid && (t.status === 'overdue' || t.status === 'unpaid' || t.status === 'first_month_unpaid');
                                if (currentFilter === 'due_soon') return !t.isPaid && t.status === 'due_soon';
                                return false;
                            });

                            const statusOrder = {
                                'overdue': 1,
                                'due_soon': 2,
                                'first_month_unpaid': 3,
                                'unpaid': 4,
                                'paid': 5
                            };

                            filteredTenants.sort((a, b) => {
                                const orderA = statusOrder[a.status];
                                const orderB = statusOrder[b.status];

                                if (orderA !== orderB) {
                                    return orderA - orderB;
                                }
                                if (a.status === 'overdue' || a.status === 'due_soon') {
                                    return a.diffDays - b.diffDays;
                                }
                                return 0;
                            });


                            if (filteredTenants.length === 0) {
                                emptyState.classList.remove('hidden');
                                tableBody.classList.add('hidden');
                            } else {
                                emptyState.classList.add('hidden');
                                tableBody.classList.remove('hidden');
                            }

                            filteredTenants.forEach(tenant => {
                                        let dueDateDisplay = '';
                                        if (tenant.dueDate) {
                                            const dueDateFormatted = new Intl.DateTimeFormat('id-ID', {
                                                day: 'numeric',
                                                month: 'long',
                                                year: 'numeric'
                                            }).format(tenant.dueDate);
                                            dueDateDisplay = dueDateFormatted;
                                            if (!tenant.isPaid && (tenant.status === 'overdue' || tenant.status === 'due_soon' || tenant.status === 'first_month_unpaid')) {
                                                dueDateDisplay += ` <span class="text-xs text-slate-500">(${tenant.statusText})</span>`;
                                            }
                                        } else {
                                            dueDateDisplay = '<span class="text-slate-500">-</span>';
                                        }

                                        const waBaseText = `Halo kak ${tenant.name} dari Kamar ${tenant.room},%0A`;
                                        let waMessageBody = '';

                                        if (tenant.status === 'overdue') {
                                            waMessageBody = `Pembayaran sewa kos Anda untuk periode berikutnya (jatuh tempo ${new Intl.DateTimeFormat('id-ID', { day: '2-digit', month: 'long', year: 'numeric' }).format(tenant.dueDate)}) sebesar ${formatCurrency(tenant.rent)} telah melewati tanggal jatuh tempo ${tenant.statusText.toLowerCase().replace('terlambat ', '')}.%0AMohon segera dilunasi untuk menghindari denda keterlambatan.`;
                                        } else if (tenant.status === 'due_soon' && tenant.diffDays === 0) {
                                            waMessageBody = `Pembayaran sewa kos Anda untuk periode berikutnya sebesar ${formatCurrency(tenant.rent)} jatuh tempo HARI INI, ${new Intl.DateTimeFormat('id-ID', { day: '2-digit', month: 'long', year: 'numeric' }).format(tenant.dueDate)}.%0AMohon segera dilunasi.`;
                                        } else if (tenant.status === 'due_soon' && tenant.diffDays > 0) {
                                            waMessageBody = `Kami ingin mengingatkan bahwa pembayaran sewa kos untuk periode berikutnya sebesar ${formatCurrency(tenant.rent)} akan jatuh tempo pada tanggal ${new Intl.DateTimeFormat('id-ID', { day: '2-digit', month: 'long', year: 'numeric' }).format(tenant.dueDate)} (dalam ${tenant.diffDays} hari).%0AMohon segera dilakukan pembayaran.`;
                                        }

                                        const waClosing = `%0ATerima kasih.%0APemilik ${NAMA_KOS}`;
                                        const waLink = (waMessageBody && tenant.phone) ? `https://wa.me/${tenant.phone}?text=${encodeURIComponent(waBaseText + waMessageBody + waClosing)}` : '';


                                        const row = `
                        <tr class="bg-white border-b border-stone-200 hover:bg-stone-50">
                            <td class="px-6 py-4 font-medium text-slate-900">
                                ${tenant.name}
                                <div class="text-xs text-slate-500">Kamar ${tenant.room}</div>
                            </td>
                            <td class="px-6 py-4">${formatCurrency(tenant.deposit)}</td>
                            <td class="px-6 py-4">${paymentIntervalLabels[tenant.paymentInterval]}</td>
                            <td class="px-6 py-4">${dueDateDisplay}</td>
                            <td class="px-6 py-4">
                                <span class="px-2 py-1 text-xs font-medium rounded-full ${tenant.statusColor}">
                                    ${tenant.statusText}
                                </span>
                            </td>
                            <td class="px-6 py-4 text-center">
                                ${!tenant.isPaid && tenant.status !== 'not_yet_entered' ? `
                                    <button data-action="log-payment" data-id="${tenant.id}" class="text-teal-600 hover:text-teal-800 font-medium mr-4">Bayar</button>
                                    ${waLink ? `<a href="${waLink}" target="_blank" class="text-amber-600 hover:text-amber-800 font-medium">WA</a>` : '<span class="text-slate-400">-</span>'}
                                ` : '<span class="text-slate-400">-</span>'}
                            </td>
                            <td class="px-6 py-4 text-center">
                                <button data-action="delete-tenant" data-id="${tenant.id}" class="text-red-600 hover:text-red-800 font-medium">Hapus</button>
                            </td>
                        </tr>
                    `;
                    tableBody.innerHTML += row;
                });
            };

            const renderMetricsAndChart = () => {
                // Untuk metrik pendapatan dan tunggakan, kita akan fokus pada pembayaran yang *seharusnya* diterima pada bulan yang sedang aktif
                // Ini akan sedikit berbeda dari sebelumnya karena interval pembayaran.
                // Pendekatan: Hitung total pendapatan bulanan yang diharapkan dari semua penyewa, dan berapa yang sudah dibayar.

                let totalExpectedMonthlyIncome = 0;
                let totalOverdueAmount = 0;
                let totalPaidThisMonth = 0;

                const currentMonthStartDate = new Date(currentSelectedDate.getFullYear(), currentSelectedDate.getMonth(), 1);
                const currentMonthEndDate = new Date(currentSelectedDate.getFullYear(), currentSelectedDate.getMonth() + 1, 0); // Last day of current month

                tenants.forEach(tenant => {
                    const statusData = getTenantPaymentStatus(tenant, currentSelectedDate);

                    // Skip tenants who haven't entered yet for income/due calculations
                    if (statusData.status === 'not_yet_entered') {
                        return;
                    }
                    
                    // Add expected rent for active tenants (even if overdue for a previous period, their rent is still expected)
                    // Simplify: Assume we are interested in how much "rent" is due for THIS currentSelectedDate's period.
                    // This is complex with various intervals. For simplicity, let's sum up rent for all active tenants.
                    // A more accurate model would involve calculating actual pro-rata income for the month.
                    // For now, let's stick to the base rent for active tenants for "expected monthly".

                    // Income: sum of paid rents whose due date (for that payment cycle) is <= currentMonthEndDate
                    // This is tricky. Let's make it simpler:
                    // Total Pemasukan (Bulan Ini) = Total pembayaran yang diterima di bulan ini
                    const paymentsInCurrentMonth = payments.filter(p => {
                        const paymentDate = new Date(p.date);
                        return paymentDate.getMonth() === currentSelectedDate.getMonth() &&
                               paymentDate.getFullYear() === currentSelectedDate.getFullYear();
                    });
                    totalPaidThisMonth += paymentsInCurrentMonth.reduce((sum, p) => sum + p.amount, 0);


                    // Tunggakan: Total harga sewa dari semua penyewa yang statusnya 'overdue' atau 'unpaid' untuk periode yang *seharusnya* dibayar
                    if (!statusData.isPaid && (statusData.status === 'overdue' || statusData.status === 'unpaid' || statusData.status === 'due_soon' || statusData.status === 'first_month_unpaid')) {
                        totalOverdueAmount += tenant.rent; // Assuming rent is the amount due for their interval
                    }
                });

                // Okupansi: Hanya hitung penyewa yang tidak berstatus 'not_yet_entered'
                const activeTenantsCount = tenants.filter(t => {
                    const status = getTenantPaymentStatus(t, currentSelectedDate).status;
                    return status !== 'not_yet_entered';
                }).length;

                document.getElementById('metric-income').textContent = formatCurrency(totalPaidThisMonth);
                document.getElementById('metric-due').textContent = formatCurrency(totalOverdueAmount);
                document.getElementById('metric-occupancy').textContent = `${activeTenantsCount} / ${tenants.length}`;


                const processedTenantsForChart = tenants.map(t => getTenantPaymentStatus(t, currentSelectedDate));
                const paidCount = processedTenantsForChart.filter(t => t.isPaid && t.status !== 'not_yet_entered').length;
                const unpaidCount = processedTenantsForChart.filter(t => !t.isPaid && t.status !== 'not_yet_entered').length;

                const ctx = document.getElementById('payment-chart').getContext('2d');
                if (paymentChart) {
                    paymentChart.destroy();
                }
                paymentChart = new Chart(ctx, {
                    type: 'doughnut',
                    data: {
                        labels: ['Lunas', 'Belum Lunas'],
                        datasets: [{
                            label: 'Status Pembayaran',
                            data: [paidCount, unpaidCount],
                            backgroundColor: [
                                'rgba(13, 148, 136, 0.8)', // teal-600
                                'rgba(245, 158, 11, 0.8)' // amber-500
                            ],
                            borderColor: [
                                '#ffffff',
                                '#ffffff'
                            ],
                            borderWidth: 2
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        cutout: '70%',
                        plugins: {
                            legend: {
                                position: 'bottom',
                                labels: {
                                    padding: 20,
                                    boxWidth: 12,
                                    font: {
                                        size: 14
                                    }
                                }
                            },
                            tooltip: {
                                callbacks: {
                                    label: function(context) {
                                        let label = context.label || '';
                                        if (label) {
                                            label += ': ';
                                        }
                                        if (context.parsed !== null) {
                                            label += context.parsed + ' penyewa';
                                        }
                                        return label;
                                    }
                                }
                            }
                        }
                    }
                });
            };

            const renderModal = (type, id = null) => {
                const modalContainer = document.getElementById('modal-container');
                let title, content;
                const tenant = id ? tenants.find(t => t.id === id) : null;

                if (type === 'addTenant') {
                    title = "Tambah Penyewa Baru";
                    content = `
                        <div class="space-y-4">
                            <div>
                                <label for="name" class="block text-sm font-medium text-slate-700">Nama Lengkap</label>
                                <input type="text" id="name" required class="mt-1 block w-full px-3 py-2 bg-white border border-stone-300 rounded-md shadow-sm focus:outline-none focus:ring-teal-500 focus:border-teal-500">
                            </div>
                            <div class="grid grid-cols-2 gap-4">
                                <div>
                                    <label for="room" class="block text-sm font-medium text-slate-700">No. Kamar</label>
                                    <input type="text" id="room" required class="mt-1 block w-full px-3 py-2 bg-white border border-stone-300 rounded-md shadow-sm focus:outline-none focus:ring-teal-500 focus:border-teal-500">
                                </div>
                                <div>
                                    <label for="phone" class="block text-sm font-medium text-slate-700">No. WA (62..)</label>
                                    <input type="text" id="phone" required placeholder="62812..." class="mt-1 block w-full px-3 py-2 bg-white border border-stone-300 rounded-md shadow-sm focus:outline-none focus:ring-teal-500 focus:border-teal-500">
                                </div>
                            </div>
                            <div class="grid grid-cols-2 gap-4">
                                <div>
                                    <label for="entryDate" class="block text-sm font-medium text-slate-700">Tanggal Masuk</label>
                                    <input type="date" id="entryDate" required class="mt-1 block w-full px-3 py-2 bg-white border border-stone-300 rounded-md shadow-sm focus:outline-none focus:ring-teal-500 focus:border-teal-500">
                                </div>
                                <div>
                                    <label for="rent" class="block text-sm font-medium text-slate-700">Harga Sewa (Rp / interval)</label>
                                    <input type="number" id="rent" required class="mt-1 block w-full px-3 py-2 bg-white border border-stone-300 rounded-md shadow-sm focus:outline-none focus:ring-teal-500 focus:border-teal-500">
                                </div>
                            </div>
                            <div>
                                <label for="paymentInterval" class="block text-sm font-medium text-slate-700">Interval Pembayaran</label>
                                <select id="paymentInterval" class="mt-1 block w-full px-3 py-2 bg-white border border-stone-300 rounded-md shadow-sm focus:outline-none focus:ring-teal-500 focus:border-teal-500">
                                    <option value="monthly">Bulanan</option>
                                    <option value="quarterly">3 Bulanan</option>
                                    <option value="biannually">6 Bulanan</option>
                                    <option value="annually">Tahunan</option>
                                </select>
                            </div>
                            <div>
                                <label for="deposit" class="block text-sm font-medium text-slate-700">Uang Deposit (Rp) <span class="text-slate-500 text-xs">(Opsional)</span></label>
                                <input type="number" id="deposit" placeholder="0" class="mt-1 block w-full px-3 py-2 bg-white border border-stone-300 rounded-md shadow-sm focus:outline-none focus:ring-teal-500 focus:border-teal-500">
                            </div>
                        </div>
                        <div class="mt-6 flex justify-end gap-3">
                            <button data-action="close-modal" class="px-4 py-2 text-sm font-medium text-slate-700 bg-white border border-stone-300 rounded-lg hover:bg-stone-50">Batal</button>
                            <button id="save-tenant-btn" class="px-4 py-2 text-sm font-medium text-white bg-teal-600 rounded-lg hover:bg-teal-700">Simpan</button>
                        </div>
                    `;
                } else if (type === 'logPayment' && tenant) {
                    const today = new Date();
                    // Untuk log pembayaran, periode yang relevan adalah periode saat ini yang sedang jatuh tempo
                    const currentStatus = getTenantPaymentStatus(tenant, currentSelectedDate);
                    const periodText = `Sewa ${paymentIntervalLabels[tenant.paymentInterval]} (Jatuh Tempo: ${new Intl.DateTimeFormat('id-ID', {day: 'numeric', month: 'long', year: 'numeric'}).format(currentStatus.dueDate)})`;

                    content = `
                        <div class="space-y-4">
                            <div>
                                <label for="payment_tenant_name" class="block text-sm font-medium text-slate-700">Penyewa</label>
                                <input type="text" id="payment_tenant_name" value="${tenant.name} (Kamar ${tenant.room})" class="mt-1 block w-full px-3 py-2 bg-stone-100 border border-stone-300 rounded-md shadow-sm" readonly>
                            </div>
                            <div>
                                <label for="payment_period_display" class="block text-sm font-medium text-slate-700">Deskripsi Pembayaran</label>
                                <input type="text" id="payment_period_display" value="${periodText}" class="mt-1 block w-full px-3 py-2 bg-stone-100 border border-stone-300 rounded-md shadow-sm" readonly>
                            </div>
                            <div>
                                <label for="payment_amount" class="block text-sm font-medium text-slate-700">Jumlah Bayar (Rp)</label>
                                <input type="number" id="payment_amount" value="${tenant.rent}" required class="mt-1 block w-full px-3 py-2 bg-white border border-stone-300 rounded-md shadow-sm focus:outline-none focus:ring-teal-500 focus:border-teal-500">
                            </div>
                            <div>
                                <label for="payment_date" class="block text-sm font-medium text-slate-700">Tanggal Pembayaran</label>
                                <input type="date" id="payment_date" value="${today.toISOString().split('T')[0]}" required class="mt-1 block w-full px-3 py-2 bg-white border border-stone-300 rounded-md shadow-sm focus:outline-none focus:ring-teal-500 focus:border-teal-500">
                            </div>
                        </div>
                        <div class="mt-6 flex justify-end gap-3">
                            <button data-action="close-modal" class="px-4 py-2 text-sm font-medium text-slate-700 bg-white border border-stone-300 rounded-lg hover:bg-stone-50">Batal</button>
                            <button id="save-payment-btn" data-id="${tenant.id}" class="px-4 py-2 text-sm font-medium text-white bg-teal-600 rounded-lg hover:bg-teal-700">Simpan Pembayaran</button>
                        </div>
                    `;
                } else if (type === 'confirmDelete' && tenant) {
                    title = "Konfirmasi Penghapusan";
                    content = `
                        <p class="text-slate-700 mb-4">Anda yakin ingin menghapus penghuni **${tenant.name} (Kamar ${tenant.room})**?</p>
                        <p class="text-sm text-red-600">Tindakan ini tidak dapat dibatalkan dan semua data pembayaran terkait juga akan terhapus.</p>
                        <div class="mt-6 flex justify-end gap-3">
                            <button data-action="close-modal" class="px-4 py-2 text-sm font-medium text-slate-700 bg-white border border-stone-300 rounded-lg hover:bg-stone-50">Batal</button>
                            <button id="confirm-delete-btn" data-id="${tenant.id}" class="px-4 py-2 text-sm font-medium text-white bg-red-600 rounded-lg hover:bg-red-700">Ya, Hapus</button>
                        </div>
                    `;
                }

                const modalHTML = `
                    <div id="modal" class="fixed inset-0 z-50 flex items-center justify-center p-4 modal-bg opacity-0">
                        <div class="bg-white rounded-xl shadow-xl w-full max-w-lg p-6 modal-content transform scale-95">
                            <div class="flex justify-between items-center mb-4">
                                <h3 class="text-lg font-bold text-slate-900">${title}</h3>
                                <button data-action="close-modal" class="text-slate-400 hover:text-slate-600">&times;</button>
                            </div>
                            <div>${content}</div>
                        </div>
                    </div>
                `;

                modalContainer.innerHTML = modalHTML;
                setTimeout(() => {
                    const modal = document.getElementById('modal');
                    modal.classList.remove('opacity-0');
                    modal.querySelector('.modal-content').classList.remove('scale-95');
                }, 10);
                
                // Set default interval if adding new tenant
                if (type === 'addTenant') {
                    document.getElementById('paymentInterval').value = 'monthly'; // Default to monthly
                }
            };

            const closeModal = () => {
                const modal = document.getElementById('modal');
                if (modal) {
                    modal.classList.add('opacity-0');
                    modal.querySelector('.modal-content').classList.add('scale-95');
                    setTimeout(() => {
                        document.getElementById('modal-container').innerHTML = '';
                    }, 300);
                }
            };

            // --- EVENT HANDLERS & ACTIONS ---
            const handleFilterClick = (e) => {
                const btn = e.target.closest('.filter-btn');
                if (!btn) return;

                currentFilter = btn.dataset.filter;

                document.querySelectorAll('.filter-btn').forEach(b => {
                    b.classList.remove('bg-teal-600', 'text-white');
                    b.classList.add('bg-white', 'text-slate-700');
                });
                btn.classList.add('bg-teal-600', 'text-white');
                btn.classList.remove('bg-white', 'text-slate-700');

                renderTable();
            };

            const handleTableClick = (e) => {
                const action = e.target.dataset.action;
                const id = parseInt(e.target.dataset.id);
                if (action === 'log-payment') {
                    renderModal('logPayment', id);
                } else if (action === 'delete-tenant') {
                    renderModal('confirmDelete', id);
                }
            };

            const handleModalAction = (e) => {
                const action = e.target.dataset.action;
                if (action === 'close-modal') {
                    closeModal();
                    return;
                }

                const btnId = e.target.id;
                if (btnId === 'save-tenant-btn') {
                    const name = document.getElementById('name').value;
                    const room = document.getElementById('room').value;
                    const phone = document.getElementById('phone').value;
                    const entryDateStr = document.getElementById('entryDate').value;
                    const rent = parseFloat(document.getElementById('rent').value);
                    const deposit = parseFloat(document.getElementById('deposit').value) || 0; // Deposit bersifat opsional, default ke 0
                    const paymentInterval = document.getElementById('paymentInterval').value;

                    if (name && room && phone && entryDateStr && !isNaN(rent) && paymentInterval) {
                        const entryDate = new Date(entryDateStr);
                        const newTenant = {
                            id: tenants.length > 0 ? Math.max(...tenants.map(t => t.id)) + 1 : 1,
                            name: name,
                            room: room,
                            phone: phone,
                            entryDate: entryDate, // Simpan sebagai objek Date
                            rent: rent,
                            deposit: deposit,
                            paymentInterval: paymentInterval,
                            lastPaidPeriodEnd: new Date(entryDate) // Awalnya, periode terakhir yang dibayar adalah tanggal masuk
                        };
                        // Untuk kasus entryDate 1 Januari, maka lastPaidPeriodEnd adalah 31 Desember tahun sebelumnya.
                        // Kita set 1 hari sebelum tanggal masuk untuk perhitungan jatuh tempo yang benar
                        newTenant.lastPaidPeriodEnd.setDate(newTenant.lastPaidPeriodEnd.getDate() - 1);

                        tenants.push(newTenant);
                        saveData(); // Simpan data setelah modifikasi
                        updateAll();
                        closeModal();
                    } else {
                        alert("Harap isi semua kolom wajib (Nama, Kamar, No. WA, Tanggal Masuk, Harga Sewa, Interval Pembayaran) dengan benar.");
                    }
                } else if (btnId === 'save-payment-btn') {
                    const tenantId = parseInt(e.target.dataset.id);
                    const tenantIndex = tenants.findIndex(t => t.id === tenantId);
                    if (tenantIndex === -1) {
                        alert("Penyewa tidak ditemukan.");
                        return;
                    }
                    const tenant = tenants[tenantIndex];

                    const paymentAmount = parseFloat(document.getElementById('payment_amount').value);
                    const paymentDate = document.getElementById('payment_date').value;

                    if (!isNaN(paymentAmount) && paymentDate) {
                        // Logika utama: Update lastPaidPeriodEnd berdasarkan paymentInterval
                        let newLastPaidPeriodEnd = new Date(tenant.lastPaidPeriodEnd);
                        
                        // Calculate the end date of the period being paid for
                        switch (tenant.paymentInterval) {
                            case 'monthly':
                                newLastPaidPeriodEnd = addMonths(newLastPaidPeriodEnd, 1);
                                break;
                            case 'quarterly':
                                newLastPaidPeriodEnd = addMonths(newLastPaidPeriodEnd, 3);
                                break;
                            case 'biannually':
                                newLastPaidPeriodEnd = addMonths(newLastPaidPeriodEnd, 6);
                                break;
                            case 'annually':
                                newLastPaidPeriodEnd = addMonths(newLastPaidPeriodEnd, 12);
                                break;
                        }
                        
                        // Ensure the newLastPaidPeriodEnd is at least the end of the *current* month being processed
                        // This handles cases where a payment is made for a future period.
                        // Or simplify: just advance based on interval
                        // For simplicity, we just advance the `lastPaidPeriodEnd` by one full interval
                        // and log the payment.

                        // Simpan pembayaran
                        payments.push({
                            tenantId: tenantId,
                            period: new Intl.DateTimeFormat('id-ID', { month: 'long', year: 'numeric' }).format(newLastPaidPeriodEnd), // Store the *end* month of the paid period
                            amount: paymentAmount,
                            date: paymentDate, // Tanggal ketika pembayaran dilakukan
                            paidForInterval: tenant.paymentInterval // Simpan interval yang dibayar
                        });

                        // Perbarui lastPaidPeriodEnd penyewa
                        tenant.lastPaidPeriodEnd = newLastPaidPeriodEnd;
                        
                        saveData(); // Simpan data setelah modifikasi
                        updateAll();
                        closeModal();
                    } else {
                        alert("Harap isi jumlah dan tanggal pembayaran dengan benar.");
                    }
                } else if (btnId === 'confirm-delete-btn') {
                    const tenantToDeleteId = parseInt(e.target.dataset.id);
                    tenants = tenants.filter(t => t.id !== tenantToDeleteId);
                    payments = payments.filter(p => p.tenantId !== tenantToDeleteId); // Hapus juga pembayaran terkait
                    saveData(); // Simpan data setelah modifikasi
                    updateAll();
                    closeModal();
                }
            };

            const handlePeriodFilter = () => {
                const month = parseInt(document.getElementById('month-select').value);
                const year = parseInt(document.getElementById('year-select').value);
                currentSelectedDate = new Date(year, month, 1); // Atur ke hari pertama bulan yang dipilih
                updateAll();
            };

            // --- INISIALISASI ---
            const updateAll = () => {
                renderTable();
                renderMetricsAndChart();
            };

            // Muat data terlebih dahulu, lalu inisialisasi pemilih dan render
            loadData();
            populateMonthYearSelectors();
            document.getElementById('filters').addEventListener('click', handleFilterClick);
            document.getElementById('tenant-table-body').addEventListener('click', handleTableClick);
            document.getElementById('modal-container').addEventListener('click', handleModalAction);
            document.getElementById('add-tenant-btn').addEventListener('click', () => renderModal('addTenant'));
            document.getElementById('apply-period-filter').addEventListener('click', handlePeriodFilter);
            document.getElementById('download-excel-btn').addEventListener('click', downloadExcel); // Tambahkan event listener untuk tombol unduh


            updateAll(); // Render awal dengan data yang dimuat

        });
    </script>

</body>

</html>